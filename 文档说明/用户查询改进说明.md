# 用户查询功能改进说明

## 改进内容（2025-12-26）

### 1. 新增显示列
在管理员的用户查询页面，现在会显示：
- **工号/学号**：根据角色显示相应的编号
  - 管理员：管理员编号（admin_no）
  - 教师：教师工号（teacher_no）
  - 学生：学号（student_no）

- **学院/部门**：显示用户所属的学院或部门名称
  - 通过 Department 表关联获取 dept_name
  - 对于不同角色，从对应的 profile 中读取

- **专业/职称**：根据角色显示不同内容
  - 学生：显示专业（major）
  - 教师：显示职称（title，如讲师、副教授、教授）
  - 管理员：显示 "-"

### 2. 联系方式可选显示
- **默认隐藏**：手机号和邮箱列默认不显示，减少信息泄露风险
- **按钮控制**：点击"显示联系方式"按钮可以切换显示/隐藏
- **动态切换**：
  - 显示时按钮文字变为"🙈 隐藏联系方式"
  - 隐藏时按钮文字为"👁️ 显示联系方式"

### 3. CSV导出增强
导出的CSV文件现在包含更完整的信息：
- 用户ID
- 用户名
- 真实姓名
- 角色
- 工号/学号
- 学院/部门
- 专业/职称
- 手机号
- 邮箱
- 状态
- 创建时间

## 使用方法

1. **查看用户信息**
   - 进入管理员后台 → 综合查询 → 用户查询
   - 设置查询条件并点击"查询"
   - 默认会显示基本信息和专业/学院信息

2. **查看联系方式**
   - 在查询结果上方点击"👁️ 显示联系方式"按钮
   - 表格会展开显示手机号和邮箱列
   - 再次点击可以隐藏这些敏感信息

3. **导出数据**
   - 点击"📥 导出CSV"按钮
   - 下载的CSV文件包含所有信息（含联系方式）

## 技术实现

### 前端（admin_query.html）
- 使用 JavaScript 控制 `.contact-column` 类的显示/隐藏
- 通过 `style="display: none"` 默认隐藏联系方式列
- 按钮点击时切换显示状态和按钮文字

### 后端（app.py）
- `admin_query()` 路由：查询用户并返回完整对象
- `admin_query_export()` 路由：从用户关联的 profile 中提取额外信息

### 数据关系
```
Users
  ├─ admin_profile (Admin) → department (Department)
  ├─ teacher_profile (Teacher) → department (Department)
  └─ student_profile (Student) → department (Department)
```

## 注意事项

1. **权限控制**：该功能仅限管理员访问
2. **数据完整性**：如果用户的 profile 或 department 为空，会显示 "-"
3. **性能考虑**：查询时会关联多个表，建议在大数据量时添加索引
4. **隐私保护**：默认隐藏联系方式，需要时手动显示

## 测试建议

1. 测试不同角色用户的显示（管理员、教师、学生）
2. 测试联系方式显示/隐藏功能
3. 测试导出CSV的完整性
4. 测试在没有关联数据时的显示（如新建用户未设置部门）
