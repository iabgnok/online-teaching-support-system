{% from "macros.html" import dashboard_nav, unified_styles, page_header %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - åœ¨çº¿æ•™å­¦æ”¯æŒç³»ç»Ÿ</title>
    {{ unified_styles() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    var url = this.getAttribute('data-url');
                    if (url) location.href = url;
                });
            });
        });
    </script>
</head>
<body>
    <div class="container">
        {{ dashboard_nav('teacher') }}
        
        {{ page_header('ğŸ” ä¿¡æ¯æŸ¥è¯¢', 'æŸ¥è¯¢å­¦ç”Ÿã€ä½œä¸šæäº¤å’Œæˆç»©ä¿¡æ¯') }}
        
        <div class="tabs">
            <div class="tab {% if query_type == 'student' %}active{% endif %}" data-url="{{ url_for('teacher_query', type='student') }}">
                å­¦ç”ŸæŸ¥è¯¢
            </div>
            <div class="tab {% if query_type == 'submission' %}active{% endif %}" data-url="{{ url_for('teacher_query', type='submission') }}">
                ä½œä¸šæäº¤æŸ¥è¯¢
            </div>
            <div class="tab {% if query_type == 'grade' %}active{% endif %}" data-url="{{ url_for('teacher_query', type='grade') }}">
                æˆç»©æŸ¥è¯¢
            </div>
        </div>
        
        <div class="content-section">
            <form method="POST" action="{{ url_for('teacher_query') }}">
                <input type="hidden" name="query_type" value="{{ query_type }}">
                
                {% if query_type == 'student' %}
                <h3>å­¦ç”ŸæŸ¥è¯¢æ¡ä»¶ï¼ˆé™ä»»æ•™ç­çº§ï¼‰</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>å­¦å·</label>
                        <input type="text" name="student_no" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>å­¦ç”Ÿå§“å</label>
                        <input type="text" name="student_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>æ•™å­¦ç­</label>
                        <select name="class_id">
                            <option value="">å…¨éƒ¨</option>
                            {% for tc, course in teaching_classes %}
                            <option value="{{ tc.class_id }}">{{ course.course_name }} - {{ tc.class_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                {% elif query_type == 'submission' %}
                <h3>ä½œä¸šæäº¤æŸ¥è¯¢æ¡ä»¶</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>æ•™å­¦ç­</label>
                        <select name="class_id">
                            <option value="">å…¨éƒ¨</option>
                            {% for tc, course in teaching_classes %}
                            <option value="{{ tc.class_id }}">{{ course.course_name }} - {{ tc.class_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ä½œä¸šæ ‡é¢˜</label>
                        <input type="text" name="assignment_title" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>æäº¤çŠ¶æ€</label>
                        <select name="status">
                            <option value="">å…¨éƒ¨</option>
                            <option value="submitted">å·²æäº¤</option>
                            <option value="graded">å·²æ‰¹æ”¹</option>
                        </select>
                    </div>
                </div>
                
                {% elif query_type == 'grade' %}
                <h3>æˆç»©æŸ¥è¯¢æ¡ä»¶ï¼ˆé™ä»»æ•™ç­çº§ï¼‰</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>å­¦å·</label>
                        <input type="text" name="student_no" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>å­¦ç”Ÿå§“å</label>
                        <input type="text" name="student_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>æ•™å­¦ç­</label>
                        <select name="class_id">
                            <option value="">å…¨éƒ¨</option>
                            {% for tc, course in teaching_classes %}
                            <option value="{{ tc.class_id }}">{{ course.course_name }} - {{ tc.class_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æœ€ä½æˆç»©</label>
                        <input type="number" name="min_grade" step="0.1" placeholder="å¦‚ï¼š60">
                    </div>
                    <div class="form-group">
                        <label>æœ€é«˜æˆç»©</label>
                        <input type="number" name="max_grade" step="0.1" placeholder="å¦‚ï¼š100">
                    </div>
                </div>
                {% endif %}
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">ğŸ” æŸ¥è¯¢</button>
                    <button type="reset" class="btn btn-secondary">ğŸ”„ é‡ç½®</button>
                </div>
            </form>
        </div>
        
        {% if results %}
        <div class="result-count" style="display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“Š æŸ¥è¯¢ç»“æœï¼šå…± {{ results|length }} æ¡è®°å½•</span>
            <a href="{{ url_for('teacher_query_export', type=query_type, **request.args) }}" class="btn btn-primary" style="text-decoration: none;">ğŸ“¥ å¯¼å‡ºCSV</a>
        </div>
        
        {% if query_type == 'student' %}
        <table>
            <thead>
                <tr>
                    <th>å­¦å·</th>
                    <th>å§“å</th>
                    <th>ä¸“ä¸š</th>
                    <th>å­¦é™¢</th>
                    <th>è¯¾ç¨‹</th>
                    <th>æ•™å­¦ç­</th>
                </tr>
            </thead>
            <tbody>
                {% for student, sc, tc, course in results %}
                <tr>
                    <td>{{ student.student_no }}</td>
                    <td>{{ student.name }}</td>
                    <td>{{ student.major or '-' }}</td>
                    <td>{{ student.department.dept_name if student.department else '-' }}</td>
                    <td>{{ course.course_name }}</td>
                    <td>{{ tc.class_name }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% elif query_type == 'submission' %}
        <table>
            <thead>
                <tr>
                    <th>å­¦å·</th>
                    <th>å§“å</th>
                    <th>ä½œä¸šæ ‡é¢˜</th>
                    <th>ç±»å‹</th>
                    <th>æ€»åˆ†</th>
                    <th>æäº¤æ—¶é—´</th>
                    <th>å¾—åˆ†</th>
                    <th>çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody>
                {% for submission, assignment, student in results %}
                <tr>
                    <td>{{ student.student_no }}</td>
                    <td>{{ student.name }}</td>
                    <td>{{ assignment.title }}</td>
                    <td>{{ 'ä½œä¸š' if assignment.type == 'homework' else 'è€ƒè¯•' }}</td>
                    <td>{{ assignment.total_score }}</td>
                    <td>{{ submission.submit_time.strftime('%Y-%m-%d %H:%M') if submission.submit_time else '-' }}</td>
                    <td>{{ submission.score if submission.score is not none else '-' }}</td>
                    <td class="{% if submission.status == 'graded' %}status-graded{% else %}status-submitted{% endif %}">
                        {{ 'å·²æ‰¹æ”¹' if submission.status == 'graded' else 'å·²æäº¤' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% elif query_type == 'grade' %}
        <table>
            <thead>
                <tr>
                    <th>å­¦å·</th>
                    <th>å§“å</th>
                    <th>è¯¾ç¨‹</th>
                    <th>ç­çº§</th>
                    <th>ä½œä¸šå¹³å‡</th>
                    <th>è€ƒè¯•å¹³å‡</th>
                    <th>æ•™å¸ˆè¯„ä»·</th>
                    <th>æœ€ç»ˆæˆç»©</th>
                </tr>
            </thead>
            <tbody>
                {% for grade, student, tc, course in results %}
                <tr>
                    <td>{{ student.student_no }}</td>
                    <td>{{ student.name }}</td>
                    <td>{{ course.course_name }}</td>
                    <td>{{ tc.class_name }}</td>
                    <td>{{ '%.1f'|format(grade.homework_avg|float) }}</td>
                    <td>{{ '%.1f'|format(grade.exam_avg|float) }}</td>
                    <td>{{ '%.1f'|format(grade.teacher_evaluation|float) }}</td>
                    <td><strong>{{ '%.1f'|format(grade.final_grade|float) }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
        
        {% elif request.method == 'POST' %}
        <div class="no-results">
            <p>ğŸ˜” æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•</p>
            <p style="font-size: 0.9em;">è¯·å°è¯•è°ƒæ•´æŸ¥è¯¢æ¡ä»¶</p>
        </div>
        {% endif %}
    </div>
</body>
</html>
