{% from "macros.html" import dashboard_nav, unified_styles %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - åœ¨çº¿æ•™å­¦æ”¯æŒç³»ç»Ÿ</title>
    {{ unified_styles() }}
    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ */
        .grade-excellent { color: #28a745; font-weight: bold; }
        .grade-fail { color: #dc3545; font-weight: bold; }
        input[type="number"] { 
            width: 100px; 
            padding: 6px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            text-align: center;
        }
        input[type="number"]:focus {
            border-color: #3498db;
            outline: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <div class="nav-links">
                <a href="{{ url_for('teacher_class_detail', class_id=class_id) }}">â† è¿”å›ç­çº§è¯¦æƒ…</a>
            </div>
            <div class="nav-links">
                <a href="{{ url_for('change_password') }}">ğŸ” ä¿®æ”¹å¯†ç </a>
                <a href="{{ url_for('logout') }}" style="color: #dc3545;">ï¿½ é€€å‡ºç™»å½•</a>
            </div>
        </div>
        
        <div class="page-header">
            <h1>{{ course.course_name }} - {{ teaching_class.class_name }}</h1>
            <p class="subtitle">å­¦æœŸï¼š{{ teaching_class.semester }}</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="content-section" style="background: #fff3cd; border-left: 4px solid #ffc107;">
            <h3 style="color: #856404; margin: 0 0 15px 0;">ğŸ“Š æˆç»©è®¡ç®—è§„åˆ™</h3>
            <p><strong>æœ€ç»ˆæˆç»© = ä½œä¸šå¹³å‡åˆ† Ã— 40% + è€ƒè¯•å¹³å‡åˆ† Ã— 40% + æ•™å¸ˆè¯¾æœ«è¯„ä»· Ã— 20%</strong></p>
            <ul>
                <li>ä½œä¸šå¹³å‡åˆ†ï¼šè‡ªåŠ¨è®¡ç®—è¯¥å­¦ç”Ÿæ‰€æœ‰ä½œä¸šçš„å¹³å‡åˆ†ï¼ˆåŒ…æ‹¬å·²æ‰¹æ”¹çš„å®é™…åˆ†æ•°å’Œæœªæäº¤/æœªæ‰¹æ”¹çš„0åˆ†ï¼‰</li>
                <li>è€ƒè¯•å¹³å‡åˆ†ï¼šè‡ªåŠ¨è®¡ç®—è¯¥å­¦ç”Ÿæ‰€æœ‰è€ƒè¯•çš„å¹³å‡åˆ†ï¼ˆåŒ…æ‹¬å·²æ‰¹æ”¹çš„å®é™…åˆ†æ•°å’Œæœªæäº¤/æœªæ‰¹æ”¹çš„0åˆ†ï¼‰</li>
                <li>æ•™å¸ˆè¯¾æœ«è¯„ä»·ï¼šéœ€è¦æ•™å¸ˆæ‰‹åŠ¨å½•å…¥ï¼ˆ0-100åˆ†ï¼‰</li>
            </ul>
            <p style="color: #dc3545;"><strong>æ³¨æ„ï¼š</strong>ç‚¹å‡»"è®¡ç®—å¹¶å‘å¸ƒæˆç»©"åï¼Œç³»ç»Ÿå°†æ ¹æ®ä¸Šè¿°è§„åˆ™è‡ªåŠ¨è®¡ç®—æ‰€æœ‰å­¦ç”Ÿçš„æœ€ç»ˆæˆç»©ã€‚</p>
        </div>

        <div class="content-section">
        <form method="POST" action="{{ url_for('teacher_calculate_grades', class_id=class_id) }}">
            <h2 class="section-title">ğŸ“ ç­çº§æˆç»©è¡¨ ({{ grades_list|length }} äºº)</h2>
            
            {% if grades_list %}
            <table>
                <thead>
                    <tr>
                        <th rowspan="2">å­¦å·</th>
                        <th rowspan="2">å§“å</th>
                        <th colspan="3">æˆç»©ç»„æˆ</th>
                        <th rowspan="2">æ•™å¸ˆè¯¾æœ«è¯„ä»·<br>(è¯·è¾“å…¥0-100)</th>
                        <th rowspan="2">æœ€ç»ˆæˆç»©</th>
                        <th rowspan="2">è®¡ç®—æ—¶é—´</th>
                    </tr>
                    <tr>
                        <th>ä½œä¸šå¹³å‡<br>(40%)</th>
                        <th>è€ƒè¯•å¹³å‡<br>(40%)</th>
                        <th>è¯„ä»·åˆ†<br>(20%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in grades_list %}
                    <tr>
                        <td>{{ item.student.student_no }}</td>
                        <td>{{ item.student.name }}</td>
                        <td>{{ '%.2f'|format(item.current_homework_avg) }}</td>
                        <td>{{ '%.2f'|format(item.current_exam_avg) }}</td>
                        <td>{{ '%.2f'|format(item.grade.teacher_evaluation) if item.grade and item.grade.teacher_evaluation is not none else '-' }}</td>
                        <td>
                            <input type="number" name="teacher_eval_{{ item.student.student_id }}" 
                                   min="0" max="100" step="0.01"
                                   value="{{ item.grade.teacher_evaluation if item.grade and item.grade.teacher_evaluation is not none else '' }}"
                                   placeholder="0-100">
                        </td>
                        <td>
                            {% if item.grade and item.grade.final_grade is not none %}
                                <span class="{% if item.grade.final_grade >= 85 %}grade-excellent{% elif item.grade.final_grade < 60 %}grade-fail{% endif %}">
                                    {{ '%.2f'|format(item.grade.final_grade) }}
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ item.grade.calculated_at.strftime('%Y-%m-%d') if item.grade and item.grade.calculated_at else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div style="margin-top: 25px; text-align: center;">
                <button type="submit" class="btn btn-success">ğŸ’¾ è®¡ç®—å¹¶å‘å¸ƒæˆç»©</button>
            </div>
            
            {% else %}
            <div class="empty-state">æš‚æ— å­¦ç”Ÿæ•°æ®</div>
            {% endif %}
        </form>
        </div>
    </div>
</body>
</html>
