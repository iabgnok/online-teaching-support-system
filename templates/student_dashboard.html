<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å­¦ç”Ÿä»ªè¡¨æ¿ - åœ¨çº¿æ•™å­¦æ”¯æŒç³»ç»Ÿ</title>
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            line-height: 1.6; 
        }
        .container { max-width: 1400px; margin: auto; }
        .header {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        h1 { 
            color: #2c3e50; 
            margin: 0 0 10px 0;
            font-size: 2em;
        }
        .welcome-text {
            color: #7f8c8d;
            margin: 0;
        }
        
        .info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .info-card h3 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .info-card p {
            margin: 8px 0;
            color: #555;
        }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 1.5em;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn { 
            padding: 10px 20px; 
            text-decoration: none; 
            border-radius: 5px; 
            display: inline-block;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-success { 
            background-color: #28a745; 
            color: white; 
        }
        .btn-success:hover {
            background-color: #218838;
        }
        
        .courses-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        
        .course-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }
        
        .course-card:hover { 
            transform: translateY(-8px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
            border-color: #3498db;
        }
        
        .course-header { 
            border-bottom: 2px solid #3498db; 
            padding-bottom: 10px; 
            margin-bottom: 15px; 
        }
        
        .course-title { 
            font-size: 1.3em; 
            font-weight: bold; 
            color: #2c3e50; 
            margin-bottom: 5px; 
        }
        
        .course-subtitle { 
            color: #7f8c8d; 
            font-size: 0.95em; 
        }
        
        .course-info { margin: 10px 0; }
        
        .info-item { 
            display: flex; 
            margin: 8px 0; 
            font-size: 0.9em; 
        }
        
        .info-label { 
            font-weight: bold; 
            width: 100px; 
            color: #555; 
        }
        
        .info-value { color: #333; }
        
        .stats-bar { 
            display: flex; 
            justify-content: space-around; 
            margin: 15px 0; 
            padding-top: 15px; 
            border-top: 1px solid #eee; 
        }
        
        .stat-item { text-align: center; }
        
        .stat-number { 
            font-size: 1.5em; 
            font-weight: bold; 
            color: #3498db; 
        }
        
        .stat-label { 
            font-size: 0.85em; 
            color: #666; 
            margin-top: 5px; 
        }
        
        .grade-excellent { color: #28a745; }
        .grade-good { color: #3498db; }
        .grade-fail { color: #dc3545; }
        .grade-none { color: #999; }
        
        .pending-list { 
            background: #fff3cd; 
            padding: 10px; 
            margin-top: 15px; 
            border-radius: 5px; 
            border-left: 3px solid #ffc107; 
        }
        
        .pending-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 0; 
            border-bottom: 1px solid #ffe69c; 
            font-size: 0.85em; 
        }
        
        .pending-item:last-child { border-bottom: none; }
        
        .assignment-type { 
            font-weight: bold; 
            white-space: nowrap; 
        }
        
        .assignment-title { 
            flex: 1; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .assignment-deadline { 
            color: #dc3545; 
            font-size: 0.9em; 
            white-space: nowrap; 
        }
        
        .btn-mini { 
            background-color: #007bff; 
            color: white; 
            padding: 3px 8px; 
            border-radius: 3px; 
            text-decoration: none; 
            font-size: 0.85em; 
            white-space: nowrap; 
        }
        
        .btn-mini:hover { 
            background-color: #0056b3; 
        }
        
        .action-buttons { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px; 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 60px 20px;
            color: #999; 
        }
        
        .empty-state p:first-child {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .logout-btn { 
            display: inline-block;
            margin-top: 20px;
            padding: 12px 30px;
            background: #e74c3c;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¨â€ğŸ“ å­¦ç”Ÿå­¦ä¹ ä¸­å¿ƒ</h1>
            <p class="welcome-text">æ¬¢è¿ï¼Œ{{ student.name }}ï¼æŸ¥çœ‹æ‚¨çš„è¯¾ç¨‹ã€ä½œä¸šå’Œæˆç»©ã€‚</p>
        </div>
        
        <!-- ï¿½ ç­¾åˆ°æé†’ (Phase 1+) -->
        {% if active_attendance %}
        <div class="section" style="background: #fff3cd; border: 1px solid #ffeeba; border-left: 5px solid #ffc107;">
             <h2 class="section-title" style="margin-bottom: 15px; font-size: 1.3em; border-bottom-color: #ffc107;">â° æ­£åœ¨è¿›è¡Œçš„ç­¾åˆ°</h2>
             <div style="display: grid; gap: 15px;">
                {% for att in active_attendance %}
                <div style="background: white; padding: 15px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee;">
                    <div>
                        <div style="font-weight: bold; font-size: 1.1em;">{{ att.course_name }} <span style="font-size: 0.8em; color: #666;">{{ att.class_name }}</span></div>
                        <div style="font-size: 0.9em; color: #555; margin-top: 5px;">
                            {% if att.current_status == 'active' %}
                                <span style="color: #28a745; font-weight: bold;">æ­£å¸¸ç­¾åˆ°è¿›è¡Œä¸­</span> - æˆªæ­¢æ—¶é—´: {{ att.end_time.strftime('%H:%M') }}
                            {% else %}
                                <span style="color: #dc3545; font-weight: bold;">âš ï¸ å·²è¿›å…¥è¿Ÿåˆ°æ—¶æ®µ</span> - æˆªæ­¢æ—¶é—´: {{ att.close_time.strftime('%H:%M') }}
                            {% endif %}
                        </div>
                    </div>
                    <form action="{{ url_for('student_checkin') }}" method="POST">
                        <input type="hidden" name="attendance_id" value="{{ att.id }}">
                        <button type="submit" class="btn btn-primary" style="background: #ffc107; color: black; border: none; font-weight: bold;">
                            ğŸ“ ç«‹å³ç­¾åˆ°
                        </button>
                    </form>
                </div>
                {% endfor %}
             </div>
        </div>
        {% endif %}

        <!-- ï¿½ğŸ“¢ å…¬å‘Šé€šçŸ¥ (Phase 1) -->
        {% if global_announcements or class_announcements %}
        <div class="section" style="background: #fff; border-left: 5px solid #3498db;">
            <h2 class="section-title" style="margin-bottom: 15px; font-size: 1.3em;">ğŸ“¢ æœ€æ–°é€šçŸ¥</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                {% if global_announcements %}
                <div>
                    <h3 style="color: #e67e22; font-size: 1.1em; margin-bottom: 10px;">ğŸ« å­¦æ ¡å…¬å‘Š</h3>
                    <ul style="list-style: none; padding: 0;">
                        {% for announcement in global_announcements %}
                        <li style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee;">
                            <div style="font-weight: bold; color: #2c3e50;">{{ announcement.title }}</div>
                            <div style="font-size: 0.9em; color: #555; margin-top: 3px;">{{ announcement.content }}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 5px;">{{ announcement.created_at.strftime('%m-%d %H:%M') }}</div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if class_announcements %}
                <div>
                    <h3 style="color: #27ae60; font-size: 1.1em; margin-bottom: 10px;">ğŸ“š è¯¾ç¨‹é€šçŸ¥</h3>
                    <ul style="list-style: none; padding: 0;">
                        {% for announcement in class_announcements %}
                        <li style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee;">
                            <div style="font-weight: bold; color: #2c3e50;">
                                <span style="background: #e8f8f5; color: #27ae60; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-right: 5px;">{{ announcement.target_class.course.course_name }}</span>
                                {{ announcement.title }}
                            </div>
                            <div style="font-size: 0.9em; color: #555; margin-top: 3px;">{{ announcement.content }}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                                {{ announcement.created_at.strftime('%m-%d %H:%M') }} Â· {{ announcement.author.real_name }}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="info-card">
            <h3>ğŸ‘¤ ä¸ªäººä¿¡æ¯</h3>
            <p><strong>å­¦å·ï¼š</strong>{{ student.student_no }}</p>
            <p><strong>å§“åï¼š</strong>{{ student.name }}</p>
            <p><strong>ä¸“ä¸šï¼š</strong>{{ student.major or '-' }}</p>
            <p><strong>å­¦é™¢ï¼š</strong>{{ student.department.dept_name if student.department else '-' }}</p>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ -->
        <div class="stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px;">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">ğŸ“š é€‰ä¿®è¯¾ç¨‹</div>
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">{{ stats.total_courses }}</div>
                <div style="font-size: 0.85em; opacity: 0.8;">é—¨è¯¾ç¨‹</div>
            </div>
            
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">ğŸ“ å¾…æäº¤ä½œä¸š</div>
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">{{ stats.total_pending_assignments }}</div>
                <div style="font-size: 0.85em; opacity: 0.8;">å¾…å®Œæˆ</div>
            </div>
            
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">ğŸ“Š å¹³å‡æˆç»©</div>
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">
                    {% if stats.average_grade > 0 %}
                        {{ stats.average_grade }}
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div style="font-size: 0.85em; opacity: 0.8;">{{ stats.graded_courses }} é—¨å·²è¯„åˆ†</div>
            </div>
        </div>
        
        <div style="margin: 20px 0;">
            <a href="{{ url_for('student_query') }}" class="btn btn-primary">ğŸ” ä¿¡æ¯æŸ¥è¯¢</a>
            <a href="{{ url_for('edit_profile') }}" class="btn btn-secondary" style="margin-left: 10px;">âœï¸ ç¼–è¾‘èµ„æ–™</a>
            <a href="{{ url_for('change_password') }}" class="btn btn-secondary" style="margin-left: 10px;">ğŸ” ä¿®æ”¹å¯†ç </a>
        </div>

        <div class="section">
            <h2 class="section-title">
                <span>ğŸ“š</span>
                æˆ‘çš„è¯¾ç¨‹ ({{ courses_info|length }} é—¨)
            </h2>
            
            {% if courses_info %}
            <div class="courses-grid">
                {% for course in courses_info %}
                <div class="course-card">
                    <div class="course-header">
                        <div class="course-title">{{ course.course_name }}</div>
                        <div class="course-subtitle">{{ course.class_name }}</div>
                    </div>
                    
                    <div class="course-info">
                        <div class="info-item">
                            <span class="info-label">å­¦æœŸï¼š</span>
                            <span class="info-value">{{ course.semester }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å­¦åˆ†ï¼š</span>
                            <span class="info-value">{{ course.credit if course.credit else '-' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æ•™å®¤ï¼š</span>
                            <span class="info-value">{{ course.classroom or '-' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ä¸Šè¯¾æ—¶é—´ï¼š</span>
                            <span class="info-value">{{ course.class_time or '-' }}</span>
                        </div>
                    </div>
                    
                    <div class="stats-bar">
                        <div class="stat-item">
                            <div class="stat-number">{{ course.pending_assignments|length }}</div>
                            <div class="stat-label">å¾…æäº¤</div>
                        </div>
                        <div class="stat-item">
                            {% if course.final_grade %}
                            <div class="stat-number grade-{% if course.final_grade >= 90 %}excellent{% elif course.final_grade >= 60 %}good{% else %}fail{% endif %}">
                                {{ '%.1f'|format(course.final_grade) }}
                            </div>
                            <div class="stat-label">æœ€ç»ˆæˆç»©</div>
                            {% else %}
                            <div class="stat-number grade-none">-</div>
                            <div class="stat-label">æš‚æ— æˆç»©</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if course.pending_assignments %}
                    <div class="pending-list">
                        <h4 style="margin: 10px 0 5px 0; font-size: 0.9em; color: #666;">å¾…æäº¤äº‹é¡¹ï¼š</h4>
                        {% for assignment in course.pending_assignments %}
                        <div class="pending-item">
                            <span class="assignment-type">{{ 'ğŸ“ ä½œä¸š' if assignment.type == 'homework' else 'ğŸ“„ è€ƒè¯•' }}</span>
                            <span class="assignment-title">{{ assignment.title }}</span>
                            <span class="assignment-deadline">æˆªæ­¢ï¼š{{ assignment.deadline.strftime('%m-%d %H:%M') }}</span>
                            <a href="{{ url_for('student_submit_assignment', assignment_id=assignment.assignment_id) }}" class="btn-mini">å»æäº¤</a>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="action-buttons">
                        <a href="{{ url_for('student_class_detail', class_id=course.class_id) }}" class="btn btn-primary">è¿›å…¥è¯¾ç¨‹</a>
                        {% if course.teacher_evaluation is not none %}
                        <a href="{{ url_for('student_view_grades', class_id=course.class_id) }}" class="btn btn-success">æŸ¥çœ‹æˆç»©</a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>ğŸ“š æ‚¨è¿˜æ²¡æœ‰é€‰ä¿®ä»»ä½•è¯¾ç¨‹</p>
                <p style="font-size: 0.9em;">è¯·è”ç³»æ•™åŠ¡å¤„è¿›è¡Œé€‰è¯¾</p>
            </div>
            {% endif %}
        </div>

        <div style="text-align: center;">
            <a href="{{ url_for('logout') }}" class="logout-btn">ğŸšª å®‰å…¨é€€å‡º</a>
        </div>
    </div>
</body>
</html>