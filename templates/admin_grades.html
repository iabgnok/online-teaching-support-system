{% from "macros.html" import dashboard_nav, unified_styles, page_header %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - åœ¨çº¿æ•™å­¦æ”¯æŒç³»ç»Ÿ</title>
    {{ unified_styles() }}
    <style>
        .badge { 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 0.85em; 
            font-weight: 600;
            white-space: nowrap;
            display: inline-block;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .grade-excellent { color: #28a745; font-weight: bold; }
        .grade-fail { color: #dc3545; font-weight: bold; }
        .action-btn { padding: 4px 8px; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="container">
        {{ dashboard_nav('admin') }}
        
        {{ page_header('ğŸ“Š æˆç»©ç®¡ç†', 'æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æˆç»©ï¼Œæ”¯æŒç­›é€‰å’Œè§£é”æ“ä½œ') }}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="info-box" style="margin-bottom: 20px;">
            <strong>ğŸ“Š ç»Ÿè®¡ï¼š</strong>
            æ€»è®°å½•æ•° <span style="color: #3498db; font-weight: bold;">{{ total_grades }}</span> æ¡ | 
            å·²å½’æ¡£ <span style="color: #28a745; font-weight: bold;">{{ finalized_count }}</span> æ¡ | 
            ä¸´æ—¶æˆç»© <span style="color: #ffc107; font-weight: bold;">{{ temp_count }}</span> æ¡
        </div>

        <!-- ç­›é€‰åŒºåŸŸ -->
        <div class="content-section">
            <h3>ç­›é€‰æ¡ä»¶</h3>
            <form method="GET" action="{{ url_for('admin_grades') }}">
                <div class="form-grid">
                    <div class="form-group">
                        <label>å­¦æœŸ</label>
                        <select name="semester" class="form-control">
                            <option value="">-- å…¨éƒ¨å­¦æœŸ --</option>
                            {% for sem in semesters %}
                                <option value="{{ sem }}" {{ 'selected' if sem == selected_semester else '' }}>
                                    {{ sem }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>æ•™å­¦ç­</label>
                        <select name="class_id" class="form-control">
                            <option value="">-- å…¨éƒ¨ç­çº§ --</option>
                            {% for tc, course in classes %}
                                <option value="{{ tc.class_id }}" {{ 'selected' if tc.class_id == selected_class_id else '' }}>
                                    {{ course.course_name }} - {{ tc.class_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>æˆç»©çŠ¶æ€</label>
                        <select name="status" class="form-control">
                            <option value="" {{ 'selected' if not selected_status else '' }}>-- å…¨éƒ¨çŠ¶æ€ --</option>
                            <option value="finalized" {{ 'selected' if selected_status == 'finalized' else '' }}>âœ“ å·²å½’æ¡£</option>
                            <option value="temp" {{ 'selected' if selected_status == 'temp' else '' }}>âš  ä¸´æ—¶æˆç»©</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ä»»è¯¾æ•™å¸ˆ</label>
                        <select name="teacher_id" class="form-control">
                            <option value="">-- å…¨éƒ¨æ•™å¸ˆ --</option>
                            {% for teacher in teachers %}
                                <option value="{{ teacher.teacher_id }}" {{ 'selected' if teacher.teacher_id == selected_teacher_id else '' }}>
                                    {{ teacher.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>å­¦ç”Ÿæœç´¢</label>
                        <input type="text" name="search" class="form-control" placeholder="å­¦å·/å§“å" value="{{ selected_search or '' }}">
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">ğŸ” æŸ¥è¯¢</button>
                    <a href="{{ url_for('admin_grades') }}" class="btn btn-secondary">ğŸ”„ é‡ç½®</a>
                </div>
            </form>
        </div>

        <!-- æˆç»©åˆ—è¡¨ -->
        <div class="content-section">
            <h3>ğŸ“ æˆç»©åˆ—è¡¨ ({{ grades_data|length }} æ¡è®°å½•)</h3>
            
            {% if grades_data %}
            <table>
                <thead>
                    <tr>
                        <th>å­¦æœŸ</th>
                        <th>è¯¾ç¨‹</th>
                        <th>ç­çº§</th>
                        <th>æ•™å¸ˆ</th>
                        <th>å­¦å·</th>
                        <th>å§“å</th>
                        <th>ä½œä¸šå¹³å‡</th>
                        <th>è€ƒè¯•å¹³å‡</th>
                        <th>æ•™å¸ˆè¯„ä»·</th>
                        <th>æœ€ç»ˆæˆç»©</th>
                        <th>çŠ¶æ€</th>
                        <th>å½’æ¡£æ—¶é—´</th>
                        <th style="min-width: 80px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for grade, student, teaching_class, course, teacher, teacher_user in grades_data %}
                    <tr>
                        <td>{{ teaching_class.semester }}</td>
                        <td>{{ course.course_name }}</td>
                        <td>{{ teaching_class.class_name }}</td>
                        <td>{{ teacher_user.real_name if teacher_user else '-' }}</td>
                        <td>{{ student.student_no }}</td>
                        <td>{{ student.name }}</td>
                        <td>{{ '%.2f'|format(grade.homework_avg) if grade.homework_avg else '-' }}</td>
                        <td>{{ '%.2f'|format(grade.exam_avg) if grade.exam_avg else '-' }}</td>
                        <td>{{ '%.2f'|format(grade.teacher_evaluation) if grade.teacher_evaluation else '-' }}</td>
                        <td>
                            {% if grade.final_grade is not none %}
                                <span class="{% if grade.final_grade >= 85 %}grade-excellent{% elif grade.final_grade < 60 %}grade-fail{% endif %}">
                                    {{ '%.2f'|format(grade.final_grade) }}
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if grade.is_finalized %}
                                <span class="badge badge-success">âœ“ å·²å½’æ¡£</span>
                            {% else %}
                                <span class="badge badge-warning">ä¸´æ—¶</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if grade.finalized_at %}
                                {{ grade.finalized_at.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td style="white-space: nowrap;">
                            {% if grade.is_finalized %}
                                <form method="POST" action="{{ url_for('admin_unlock_grade', grade_id=grade.grade_id) }}" style="display: inline;" onsubmit="return confirm('ç¡®å®šè¦è§£é”è¿™æ¡æˆç»©å—ï¼Ÿ\n\nè§£é”åæ•™å¸ˆå¯ä»¥é‡æ–°è®¡ç®—å’Œå½’æ¡£è¯¥æˆç»©ã€‚')">
                                    <button type="submit" class="btn btn-warning action-btn">ğŸ”“ è§£é”</button>
                                </form>
                            {% else %}
                                <span style="color: #999;">å·²è§£é”</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- æ‰¹é‡æ“ä½œ -->
            {% if selected_class_id %}
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px;">
                <strong>æ‰¹é‡æ“ä½œï¼š</strong>
                <form method="POST" action="{{ url_for('admin_unlock_class_grades', class_id=selected_class_id) }}" style="display: inline;" onsubmit="return confirm('âš ï¸ ç¡®å®šè¦è§£é”å½“å‰ç­çº§çš„æ‰€æœ‰å·²å½’æ¡£æˆç»©å—ï¼Ÿ\n\nè¿™å°†è§£é” {{ finalized_count }} æ¡å·²å½’æ¡£çš„æˆç»©è®°å½•ã€‚')">
                    <button type="submit" class="btn btn-warning">ğŸ”“ è§£é”å½“å‰ç­çº§æ‰€æœ‰æˆç»©</button>
                </form>
            </div>
            {% endif %}
            
            {% else %}
            <div class="empty-state">æš‚æ— æˆç»©è®°å½•</div>
            {% endif %}
        </div>

        <div style="margin-top: 20px;">
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">è¿”å›ç®¡ç†åå°</a>
        </div>
    </div>
</body>
</html>
