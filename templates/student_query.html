{% from "macros.html" import dashboard_nav, unified_styles, page_header %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - åœ¨çº¿æ•™å­¦æ”¯æŒç³»ç»Ÿ</title>
    {{ unified_styles() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    var url = this.getAttribute('data-url');
                    if (url) location.href = url;
                });
            });
        });
    </script>
</head>
<body>
    <div class="container">
        {{ dashboard_nav('student') }}
        
        {{ page_header('ğŸ” ä¿¡æ¯æŸ¥è¯¢', 'æŸ¥è¯¢æˆ‘çš„è¯¾ç¨‹ã€ä½œä¸šå’Œæˆç»©ä¿¡æ¯') }}
        
        <div class="tabs">
            <div class="tab {% if query_type == 'course' %}active{% endif %}" data-url="{{ url_for('student_query', type='course') }}">
                è¯¾ç¨‹æŸ¥è¯¢
            </div>
            <div class="tab {% if query_type == 'assignment' %}active{% endif %}" data-url="{{ url_for('student_query', type='assignment') }}">
                ä½œä¸šæŸ¥è¯¢
            </div>
            <div class="tab {% if query_type == 'grade' %}active{% endif %}" data-url="{{ url_for('student_query', type='grade') }}">
                æˆç»©æŸ¥è¯¢
            </div>
        </div>
        
        <div class="content-section">
            <form method="POST" action="{{ url_for('student_query') }}">
                <input type="hidden" name="query_type" value="{{ query_type }}">
                
                {% if query_type == 'course' %}
                <h3>æˆ‘çš„è¯¾ç¨‹æŸ¥è¯¢</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>è¯¾ç¨‹åç§°</label>
                        <input type="text" name="course_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>å­¦æœŸ</label>
                        <input type="text" name="semester" placeholder="å¦‚ï¼š2024-2025-1">
                    </div>
                </div>
                
                {% elif query_type == 'assignment' %}
                <h3>æˆ‘çš„ä½œä¸šæŸ¥è¯¢</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>è¯¾ç¨‹åç§°</label>
                        <input type="text" name="course_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>ç±»å‹</label>
                        <select name="assignment_type">
                            <option value="">å…¨éƒ¨</option>
                            <option value="homework">ä½œä¸š</option>
                            <option value="exam">è€ƒè¯•</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æäº¤çŠ¶æ€</label>
                        <select name="status">
                            <option value="">å…¨éƒ¨</option>
                            <option value="not_submitted">æœªæäº¤</option>
                            <option value="submitted">å·²æäº¤</option>
                            <option value="graded">å·²æ‰¹æ”¹</option>
                        </select>
                    </div>
                </div>
                
                {% elif query_type == 'grade' %}
                <h3>æˆ‘çš„æˆç»©æŸ¥è¯¢</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>è¯¾ç¨‹åç§°</label>
                        <input type="text" name="course_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>æœ€ä½æˆç»©</label>
                        <input type="number" name="min_grade" step="0.1" placeholder="å¦‚ï¼š60">
                    </div>
                    <div class="form-group">
                        <label>æœ€é«˜æˆç»©</label>
                        <input type="number" name="max_grade" step="0.1" placeholder="å¦‚ï¼š100">
                    </div>
                </div>
                {% endif %}
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">ğŸ” æŸ¥è¯¢</button>
                    <button type="reset" class="btn btn-secondary">ğŸ”„ é‡ç½®</button>
                </div>
            </form>
        </div>
        
        {% if results %}
        <div class="result-count" style="display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“Š æŸ¥è¯¢ç»“æœï¼šå…± {{ results|length }} æ¡è®°å½•</span>
            <a href="{{ url_for('student_query_export', type=query_type, **request.args) }}" class="btn btn-primary" style="text-decoration: none;">ğŸ“¥ å¯¼å‡ºCSV</a>
        </div>
        
        {% if query_type == 'course' %}
        <table>
            <thead>
                <tr>
                    <th>è¯¾ç¨‹åç§°</th>
                    <th>ç­çº§</th>
                    <th>å­¦æœŸ</th>
                    <th>å­¦åˆ†</th>
                    <th>ä¸Šè¯¾æ—¶é—´</th>
                    <th>æ•™å®¤</th>
                    <th>é€‰è¯¾æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for sc, tc, course in results %}
                <tr>
                    <td>{{ course.course_name }}</td>
                    <td>{{ tc.class_name }}</td>
                    <td>{{ tc.semester }}</td>
                    <td>{{ course.credit }}</td>
                    <td>{{ tc.class_time or '-' }}</td>
                    <td>{{ tc.classroom or '-' }}</td>
                    <td>{{ sc.enroll_time.strftime('%Y-%m-%d') if sc.enroll_time else '-' }}</td>
                    <td>
                        <a href="{{ url_for('student_class_detail', class_id=tc.class_id) }}" class="btn btn-primary" style="padding: 5px 10px; font-size: 0.85em;">æŸ¥çœ‹è¯¦æƒ…</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% elif query_type == 'assignment' %}
        <table>
            <thead>
                <tr>
                    <th>è¯¾ç¨‹</th>
                    <th>ä½œä¸šæ ‡é¢˜</th>
                    <th>ç±»å‹</th>
                    <th>æ€»åˆ†</th>
                    <th>æˆªæ­¢æ—¶é—´</th>
                    <th>æäº¤çŠ¶æ€</th>
                    <th>å¾—åˆ†</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for item in results %}
                <tr>
                    <td>{{ item.course.course_name }}</td>
                    <td>{{ item.assignment.title }}</td>
                    <td>{{ 'ğŸ“ ä½œä¸š' if item.assignment.type == 'homework' else 'ğŸ“„ è€ƒè¯•' }}</td>
                    <td>{{ item.assignment.total_score }}</td>
                    <td>{{ item.assignment.deadline.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td class="{% if item.submission and item.submission.status == 'graded' %}status-graded{% elif item.submission %}status-submitted{% else %}status-not-submitted{% endif %}">
                        {% if item.submission and item.submission.status == 'graded' %}
                            å·²æ‰¹æ”¹
                        {% elif item.submission %}
                            å·²æäº¤
                        {% else %}
                            æœªæäº¤
                        {% endif %}
                    </td>
                    <td>
                        {% if item.submission and item.submission.status == 'graded' %}
                            <strong>{{ item.submission.score }}</strong>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if not item.submission %}
                            <a href="{{ url_for('student_submit_assignment', assignment_id=item.assignment.assignment_id) }}" class="btn btn-primary" style="padding: 5px 10px; font-size: 0.85em;">å»æäº¤</a>
                        {% else %}
                            <a href="{{ url_for('student_submit_assignment', assignment_id=item.assignment.assignment_id) }}" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.85em;">æŸ¥çœ‹</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% elif query_type == 'grade' %}
        <table>
            <thead>
                <tr>
                    <th>è¯¾ç¨‹åç§°</th>
                    <th>ç­çº§</th>
                    <th>ä½œä¸šå¹³å‡</th>
                    <th>è€ƒè¯•å¹³å‡</th>
                    <th>æ•™å¸ˆè¯„ä»·</th>
                    <th>æœ€ç»ˆæˆç»©</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for grade, tc, course in results %}
                <tr>
                    <td>{{ course.course_name }}</td>
                    <td>{{ tc.class_name }}</td>
                    <td>{{ '%.1f'|format(grade.homework_avg|float) if grade.homework_avg is not none else '-' }}</td>
                    <td>{{ '%.1f'|format(grade.exam_avg|float) if grade.exam_avg is not none else '-' }}</td>
                    <td>{{ '%.1f'|format(grade.teacher_evaluation|float) if grade.teacher_evaluation is not none else '-' }}</td>
                    <td><strong>{{ '%.1f'|format(grade.final_grade|float) if grade.final_grade is not none else '-' }}</strong></td>
                    <td>
                        <a href="{{ url_for('student_view_grades', class_id=tc.class_id) }}" class="btn btn-success" style="padding: 5px 10px; font-size: 0.85em;">æŸ¥çœ‹è¯¦æƒ…</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
        
        {% elif request.method == 'POST' %}
        <div class="no-results">
            <p>ğŸ˜” æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•</p>
            <p style="font-size: 0.9em;">è¯·å°è¯•è°ƒæ•´æŸ¥è¯¢æ¡ä»¶</p>
        </div>
        {% endif %}
    </div>
</body>
</html>
