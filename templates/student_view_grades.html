{% from "macros.html" import dashboard_nav, unified_styles, page_header %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - åœ¨çº¿æ•™å­¦æ”¯æŒç³»ç»Ÿ</title>
    {{ unified_styles() }}
    <style>
        .grade-summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin: 20px 0; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .grade-number { font-size: 4em; font-weight: bold; margin: 20px 0; }
        .grade-breakdown { display: flex; justify-content: space-around; margin-top: 20px; flex-wrap: wrap; gap: 20px; }
        .breakdown-item { text-align: center; min-width: 150px; }
        .breakdown-value { font-size: 1.8em; font-weight: bold; }
        .breakdown-label { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
        .score-excellent { color: #28a745; font-weight: bold; }
        .score-good { color: #007bff; font-weight: bold; }
        .score-pass { color: #ffc107; font-weight: bold; }
        .score-fail { color: #dc3545; font-weight: bold; }
        .formula-box { background: #e7f3ff; border-left: 4px solid #3498db; padding: 15px; margin: 20px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        {{ dashboard_nav('student') }}
        
        {{ page_header(course.course_name + ' - æˆç»©è¯¦æƒ…', '') }}
        
        <div class="info-card">
            <p><strong>è¯¾ç¨‹ä»£ç ï¼š</strong>{{ course.course_code }}</p>
            <p><strong>ç­çº§ï¼š</strong>{{ teaching_class.class_name }}</p>
            <p><strong>å­¦æœŸï¼š</strong>{{ teaching_class.semester }}</p>
            <p><strong>å­¦åˆ†ï¼š</strong>{{ course.credit }}</p>
        </div>

        {% if grade %}
        <div class="grade-summary">
            <h2 style="margin-top: 0;">ğŸ“Š æœ€ç»ˆæˆç»©</h2>
            <div class="grade-number">{{ '%.1f'|format(grade.final_grade) }}</div>
            <div style="font-size: 1.2em;">
                {% if grade.final_grade >= 90 %}
                    ä¼˜ç§€ (A)
                {% elif grade.final_grade >= 80 %}
                    è‰¯å¥½ (B)
                {% elif grade.final_grade >= 70 %}
                    ä¸­ç­‰ (C)
                {% elif grade.final_grade >= 60 %}
                    åŠæ ¼ (D)
                {% else %}
                    ä¸åŠæ ¼ (F)
                {% endif %}
            </div>
            
            <div class="grade-breakdown">
                <div class="breakdown-item">
                    <div class="breakdown-value">{{ '%.1f'|format(grade.homework_avg|float) if grade.homework_avg is not none else '-' }}</div>
                    <div class="breakdown-label">ä½œä¸šå¹³å‡åˆ†</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-value">{{ '%.1f'|format(grade.exam_avg|float) if grade.exam_avg is not none else '-' }}</div>
                    <div class="breakdown-label">è€ƒè¯•å¹³å‡åˆ†</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-value">{{ '%.1f'|format(grade.teacher_evaluation|float) if grade.teacher_evaluation is not none else '-' }}</div>
                    <div class="breakdown-label">æ•™å¸ˆè¯„ä»·</div>
                </div>
            </div>
        </div>

        <div class="formula-box">
            <strong>ğŸ“ æˆç»©è®¡ç®—å…¬å¼ï¼š</strong><br>
            æœ€ç»ˆæˆç»© = ä½œä¸šå¹³å‡åˆ† Ã— 40% + è€ƒè¯•å¹³å‡åˆ† Ã— 40% + æ•™å¸ˆè¯„ä»· Ã— 20%<br>
            <small style="color: #666;">= {{ '%.1f'|format(grade.homework_avg|float) if grade.homework_avg is not none else '0.0' }} Ã— 0.4 + {{ '%.1f'|format(grade.exam_avg|float) if grade.exam_avg is not none else '0.0' }} Ã— 0.4 + {{ '%.1f'|format(grade.teacher_evaluation|float) if grade.teacher_evaluation is not none else '0.0' }} Ã— 0.2 = {{ '%.1f'|format(grade.final_grade|float) if grade.final_grade is not none else '0.0' }}</small>
        </div>
        {% else %}
        <div class="grade-summary">
            <h2 style="margin-top: 0;">ğŸ“Š æœ€ç»ˆæˆç»©</h2>
            <div style="font-size: 2em; margin: 20px 0;">æš‚æ— æˆç»©</div>
            <p>æ•™å¸ˆå°šæœªå‘å¸ƒæˆç»©ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
        </div>
        {% endif %}

        <!-- ä½œä¸šæˆç»©æ˜ç»† -->
        <div class="section">
            <div class="section-header">ğŸ“ ä½œä¸šæˆç»©æ˜ç»†</div>
            <div class="section-content">
                {% if homework_submissions %}
                <table>
                    <thead>
                        <tr>
                            <th>ä½œä¸šæ ‡é¢˜</th>
                            <th>æ€»åˆ†</th>
                            <th>æäº¤æ—¶é—´</th>
                            <th>å¾—åˆ†</th>
                            <th>æ•™å¸ˆåé¦ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for submission, assignment in homework_submissions %}
                        <tr>
                            <td>{{ assignment.title }}</td>
                            <td>{{ assignment.total_score }}</td>
                            <td>{{ submission.submit_time.strftime('%Y-%m-%d %H:%M') if submission.submit_time else '-' }}</td>
                            <td>
                                {% if submission.status == 'graded' %}
                                    {% set score_float = submission.score|float %}
                                    {% set total_float = assignment.total_score|float %}
                                    <span class="{% if score_float >= total_float * 0.9 %}score-excellent{% elif score_float >= total_float * 0.6 %}score-good{% else %}score-fail{% endif %}">
                                        {{ submission.score }}
                                    </span>
                                {% else %}
                                    <span style="color: #ffc107;">å¾…æ‰¹æ”¹</span>
                                {% endif %}
                            </td>
                            <td>{{ submission.feedback or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if homework_submissions|length > 0 and grade and grade.homework_avg is not none %}
                <p style="margin-top: 15px; text-align: right;"><strong>å¹³å‡åˆ†ï¼š{{ '%.1f'|format(grade.homework_avg|float) }}</strong></p>
                {% elif homework_submissions|length > 0 %}
                <p style="margin-top: 15px; text-align: right; color: #999;"><strong>å¹³å‡åˆ†ï¼šæš‚æœªè®¡ç®—</strong></p>
                {% endif %}
                {% else %}
                <div class="empty-message">æš‚æ— ä½œä¸šæˆç»©</div>
                {% endif %}
            </div>
        </div>

        <!-- è€ƒè¯•æˆç»©æ˜ç»† -->
        <div class="section">
            <div class="section-header">ğŸ“„ è€ƒè¯•æˆç»©æ˜ç»†</div>
            <div class="section-content">
                {% if exam_submissions %}
                <table>
                    <thead>
                        <tr>
                            <th>è€ƒè¯•åç§°</th>
                            <th>æ€»åˆ†</th>
                            <th>æäº¤æ—¶é—´</th>
                            <th>å¾—åˆ†</th>
                            <th>æ•™å¸ˆåé¦ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for submission, assignment in exam_submissions %}
                        <tr>
                            <td>{{ assignment.title }}</td>
                            <td>{{ assignment.total_score }}</td>
                            <td>{{ submission.submit_time.strftime('%Y-%m-%d %H:%M') if submission.submit_time else '-' }}</td>
                            <td>
                                {% if submission.status == 'graded' %}
                                    {% set score_float = submission.score|float %}
                                    {% set total_float = assignment.total_score|float %}
                                    <span class="{% if score_float >= total_float * 0.9 %}score-excellent{% elif score_float >= total_float * 0.6 %}score-good{% else %}score-fail{% endif %}">
                                        {{ submission.score }}
                                    </span>
                                {% else %}
                                    <span style="color: #ffc107;">å¾…æ‰¹æ”¹</span>
                                {% endif %}
                            </td>
                            <td>{{ submission.feedback or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if exam_submissions|length > 0 and grade and grade.exam_avg is not none %}
                <p style="margin-top: 15px; text-align: right;"><strong>å¹³å‡åˆ†ï¼š{{ '%.1f'|format(grade.exam_avg|float) }}</strong></p>
                {% elif exam_submissions|length > 0 %}
                <p style="margin-top: 15px; text-align: right; color: #999;"><strong>å¹³å‡åˆ†ï¼šæš‚æœªè®¡ç®—</strong></p>
                {% endif %}
                {% else %}
                <div class="empty-message">æš‚æ— è€ƒè¯•æˆç»©</div>
                {% endif %}
            </div>
        </div>

        <div style="margin-top: 30px;">
            <a href="{{ url_for('student_class_detail', class_id=teaching_class.class_id) }}" class="btn btn-secondary">è¿”å›è¯¾ç¨‹è¯¦æƒ…</a>
            <a href="{{ url_for('student_dashboard') }}" class="btn btn-secondary">è¿”å›è¯¾ç¨‹åˆ—è¡¨</a>
        </div>
    </div>
</body>
</html>
