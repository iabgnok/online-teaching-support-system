{% from "macros.html" import dashboard_nav, unified_styles, page_header %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - åœ¨çº¿æ•™å­¦æ”¯æŒç³»ç»Ÿ</title>
    {{ unified_styles() }}
    <style>
        .grade-summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin: 20px 0; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        .grade-number { font-size: 4em; font-weight: bold; margin: 20px 0; }
        .grade-breakdown { display: flex; justify-content: space-around; margin-top: 20px; flex-wrap: wrap; gap: 20px; }
        .breakdown-item { text-align: center; min-width: 150px; }
        .breakdown-value { font-size: 1.8em; font-weight: bold; }
        .breakdown-label { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
        .score-excellent { color: #28a745; font-weight: bold; }
        .score-good { color: #007bff; font-weight: bold; }
        .score-fail { color: #dc3545; font-weight: bold; }
        .formula-box { background: #e7f3ff; border-left: 4px solid #3498db; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .badge { padding: 6px 12px; border-radius: 12px; font-size: 0.9em; font-weight: 600; position: absolute; top: 20px; right: 20px; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .status-info { background: #d1ecf1; border-left: 4px solid #0c5460; padding: 15px; margin: 20px 0; border-radius: 5px; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        {{ dashboard_nav('student') }}
        
        {{ page_header(course.course_name + ' - æˆç»©è¯¦æƒ…', '') }}
        
        <div class="info-card">
            <p><strong>è¯¾ç¨‹ä»£ç ï¼š</strong>{{ course.course_code }}</p>
            <p><strong>ç­çº§ï¼š</strong>{{ teaching_class.class_name }}</p>
            <p><strong>å­¦æœŸï¼š</strong>{{ teaching_class.semester }}</p>
            <p><strong>å­¦åˆ†ï¼š</strong>{{ course.credit }}</p>
        </div>

        {% if grade_display %}
        <div class="grade-summary">
            <!-- æˆç»©çŠ¶æ€å¾½ç«  -->
            {% if grade_display.is_finalized %}
                <span class="badge badge-success">âœ“ æœ€ç»ˆæˆç»©</span>
            {% else %}
                <span class="badge badge-warning">ä¸´æ—¶æˆç»©</span>
            {% endif %}
            
            <h2 style="margin-top: 0;">ğŸ“Š {{ 'æœ€ç»ˆæˆç»©' if grade_display.is_finalized else 'å½“å‰æˆç»©' }}</h2>
            <div class="grade-number">{{ '%.1f'|format(grade_display.final_grade) }}</div>
            <div style="font-size: 1.2em;">
                {% if grade_display.final_grade >= 90 %}
                    ä¼˜ç§€ (A)
                {% elif grade_display.final_grade >= 80 %}
                    è‰¯å¥½ (B)
                {% elif grade_display.final_grade >= 70 %}
                    ä¸­ç­‰ (C)
                {% elif grade_display.final_grade >= 60 %}
                    åŠæ ¼ (D)
                {% else %}
                    ä¸åŠæ ¼ (F)
                {% endif %}
            </div>
            
            <div class="grade-breakdown">
                <div class="breakdown-item">
                    <div class="breakdown-value">{{ '%.1f'|format(grade_display.homework_avg) }}</div>
                    <div class="breakdown-label">ä½œä¸šå¹³å‡åˆ†</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-value">{{ '%.1f'|format(grade_display.exam_avg) }}</div>
                    <div class="breakdown-label">è€ƒè¯•å¹³å‡åˆ†</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-value">{{ '%.1f'|format(grade_display.teacher_evaluation) }}</div>
                    <div class="breakdown-label">æ•™å¸ˆè¯„ä»·</div>
                </div>
            </div>
        </div>

        {% if grade_display.is_finalized %}
        <div class="status-info">
            <strong>âœ“ æˆç»©å·²å½’æ¡£</strong><br>
            æ­¤æˆç»©ä¸ºæ•™å¸ˆç¡®è®¤çš„æœ€ç»ˆæˆç»©ï¼Œå·²äº <strong>{{ grade_display.finalized_at.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}</strong> å½’æ¡£ã€‚<br>
            å½’æ¡£åçš„æˆç»©ä¸ä¼šå†å› åç»­ä½œä¸šæ‰¹æ”¹è€Œå˜åŒ–ã€‚
        </div>
        {% else %}
        <div class="status-info" style="background: #fff3cd; border-left-color: #ffc107; color: #856404;">
            <strong>âš ï¸ ä¸´æ—¶æˆç»©</strong><br>
            æ­¤æˆç»©ä¸ºå½“å‰è®¡ç®—çš„ä¸´æ—¶æˆç»©ï¼Œä¼šéšç€ä½œä¸šæ‰¹æ”¹è€Œæ›´æ–°ã€‚<br>
            æ•™å¸ˆç¡®è®¤å½’æ¡£åï¼Œæ‚¨å°†çœ‹åˆ°æœ€ç»ˆç¡®å®šçš„æˆç»©ã€‚
        </div>
        {% endif %}

        <div class="formula-box">
            <strong>ğŸ“ æˆç»©è®¡ç®—å…¬å¼ï¼š</strong><br>
            æœ€ç»ˆæˆç»© = ä½œä¸šå¹³å‡åˆ† Ã— 30% + è€ƒè¯•å¹³å‡åˆ† Ã— 50% + æ•™å¸ˆè¯„ä»· Ã— 20%<br>
            <small style="color: #666;">= {{ '%.1f'|format(grade_display.homework_avg) }} Ã— 0.3 + {{ '%.1f'|format(grade_display.exam_avg) }} Ã— 0.5 + {{ '%.1f'|format(grade_display.teacher_evaluation) }} Ã— 0.2 = {{ '%.1f'|format(grade_display.final_grade) }}</small>
        </div>
        {% else %}
        <div class="grade-summary">
            <h2 style="margin-top: 0;">ğŸ“Š æœ€ç»ˆæˆç»©</h2>
            <div style="font-size: 2em; margin: 20px 0;">æš‚æ— æˆç»©</div>
            <p>æ•™å¸ˆå°šæœªå‘å¸ƒæˆç»©ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
        </div>
        {% endif %}

        <!-- ä½œä¸šæˆç»©æ˜ç»† -->
        <div class="section">
            <div class="section-header">ğŸ“ ä½œä¸šæˆç»©æ˜ç»†</div>
            <div class="section-content">
                {% if homework_submissions %}
                <table>
                    <thead>
                        <tr>
                            <th>ä½œä¸šæ ‡é¢˜</th>
                            <th>æ€»åˆ†</th>
                            <th>æäº¤æ—¶é—´</th>
                            <th>å¾—åˆ†</th>
                            <th>æ•™å¸ˆåé¦ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for submission, assignment in homework_submissions %}
                        <tr>
                            <td>{{ assignment.title }}</td>
                            <td>{{ assignment.total_score }}</td>
                            <td>{{ submission.submit_time.strftime('%Y-%m-%d %H:%M') if submission.submit_time else '-' }}</td>
                            <td>
                                {% if submission.status == 'graded' %}
                                    {% set score_float = submission.score|float %}
                                    {% set total_float = assignment.total_score|float %}
                                    <span class="{% if score_float >= total_float * 0.9 %}score-excellent{% elif score_float >= total_float * 0.6 %}score-good{% else %}score-fail{% endif %}">
                                        {{ submission.score }}
                                    </span>
                                {% else %}
                                    <span style="color: #ffc107;">å¾…æ‰¹æ”¹</span>
                                {% endif %}
                            </td>
                            <td>{{ submission.feedback or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if homework_submissions|length > 0 and grade_display and grade_display.homework_avg %}
                <p style="margin-top: 15px; text-align: right;"><strong>å¹³å‡åˆ†ï¼š{{ '%.1f'|format(grade_display.homework_avg) }}</strong></p>
                {% endif %}
                {% else %}
                <div class="empty-message">æš‚æ— ä½œä¸šæˆç»©</div>
                {% endif %}
            </div>
        </div>

        <!-- è€ƒè¯•æˆç»©æ˜ç»† -->
        <div class="section">
            <div class="section-header">ğŸ“„ è€ƒè¯•æˆç»©æ˜ç»†</div>
            <div class="section-content">
                {% if exam_submissions %}
                <table>
                    <thead>
                        <tr>
                            <th>è€ƒè¯•åç§°</th>
                            <th>æ€»åˆ†</th>
                            <th>æäº¤æ—¶é—´</th>
                            <th>å¾—åˆ†</th>
                            <th>æ•™å¸ˆåé¦ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for submission, assignment in exam_submissions %}
                        <tr>
                            <td>{{ assignment.title }}</td>
                            <td>{{ assignment.total_score }}</td>
                            <td>{{ submission.submit_time.strftime('%Y-%m-%d %H:%M') if submission.submit_time else '-' }}</td>
                            <td>
                                {% if submission.status == 'graded' %}
                                    {% set score_float = submission.score|float %}
                                    {% set total_float = assignment.total_score|float %}
                                    <span class="{% if score_float >= total_float * 0.9 %}score-excellent{% elif score_float >= total_float * 0.6 %}score-good{% else %}score-fail{% endif %}">
                                        {{ submission.score }}
                                    </span>
                                {% else %}
                                    <span style="color: #ffc107;">å¾…æ‰¹æ”¹</span>
                                {% endif %}
                            </td>
                            <td>{{ submission.feedback or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if exam_submissions|length > 0 and grade_display and grade_display.exam_avg %}
                <p style="margin-top: 15px; text-align: right;"><strong>å¹³å‡åˆ†ï¼š{{ '%.1f'|format(grade_display.exam_avg) }}</strong></p>
                {% endif %}
                {% else %}
                <div class="empty-message">æš‚æ— è€ƒè¯•æˆç»©</div>
                {% endif %}
            </div>
        </div>

        <div style="margin-top: 30px;">
            <a href="{{ url_for('student_class_detail', class_id=teaching_class.class_id) }}" class="btn btn-secondary">è¿”å›è¯¾ç¨‹è¯¦æƒ…</a>
            <a href="{{ url_for('student_dashboard') }}" class="btn btn-secondary">è¿”å›è¯¾ç¨‹åˆ—è¡¨</a>
        </div>
    </div>
</body>
</html>
