# æ•°æ®å¯¼å…¥åŠŸèƒ½æ›´æ–°è¯´æ˜

## ğŸ“‹ æ›´æ–°æ¦‚è¿°

æ ¹æ®æ•°æ®åº“è§„èŒƒåŒ–ä¿®æ”¹ï¼ˆç¬¬ä¸‰èŒƒå¼ï¼‰ï¼Œæ•°æ®å¯¼å…¥åŠŸèƒ½å·²å®Œæˆä»¥ä¸‹æ›´æ–°ï¼š

### 1. æ–°å¢åŠŸèƒ½

#### ğŸ¢ æ‰¹é‡å¯¼å…¥é™¢ç³» (admin_import_departments)
- **è·¯ç”±**: `/admin/import_departments`
- **æ¨¡æ¿**: `templates/admin_import_departments.html`
- **æ–‡ä»¶æ ¼å¼**: CSVï¼Œå¿…éœ€åˆ—ï¼š`dept_name`
- **è¯´æ˜**: **å¿…é¡»å…ˆå¯¼å…¥é™¢ç³»æ•°æ®ï¼Œå†å¯¼å…¥ç”¨æˆ·æ•°æ®**

**ç¤ºä¾‹ CSV æ ¼å¼**ï¼š
```csv
dept_name
è½¯ä»¶å·¥ç¨‹å­¦é™¢
è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯å­¦é™¢
äººå·¥æ™ºèƒ½å­¦é™¢
æ•°æ®ç§‘å­¦å­¦é™¢
ç½‘ç»œç©ºé—´å®‰å…¨å­¦é™¢
ä¿¡æ¯ç®¡ç†å­¦é™¢
æ•™åŠ¡å¤„
```

---

### 2. æ›´æ–°åŠŸèƒ½

#### ğŸ‘¤ æ‰¹é‡å¯¼å…¥ç”¨æˆ· (admin_batch_import)
- **è·¯ç”±**: `/admin/import_users`
- **æ¨¡æ¿**: `templates/admin_batch_import.html`ï¼ˆå·²æ›´æ–°ï¼‰

**æ–°çš„ CSV æ ¼å¼è¦æ±‚**ï¼š
```csv
username,password,name,gender,role,role_no,phone,email,department,major,grade,class_name,title
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µå | å¿…å¡« | è¯´æ˜ | é€‚ç”¨è§’è‰² |
|--------|------|------|----------|
| `username` | âœ… | ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰ | æ‰€æœ‰ |
| `password` | âœ… | å¯†ç ï¼ˆæ˜æ–‡ï¼Œç³»ç»Ÿè‡ªåŠ¨åŠ å¯†ï¼‰ | æ‰€æœ‰ |
| `name` | âœ… | çœŸå®å§“åï¼ˆå­˜å‚¨åœ¨ Users è¡¨ï¼‰ | æ‰€æœ‰ |
| `gender` | âœ… | æ€§åˆ«ï¼ˆå­˜å‚¨åœ¨ Users è¡¨ï¼‰ | æ‰€æœ‰ |
| `role` | âœ… | è§’è‰²ï¼šadmin/teacher/student | æ‰€æœ‰ |
| `role_no` | âœ… | å·¥å·/å­¦å·ï¼ˆå”¯ä¸€ï¼‰ | æ‰€æœ‰ |
| `phone` | âŒ | è”ç³»ç”µè¯ | æ‰€æœ‰ |
| `email` | âŒ | ç”µå­é‚®ç®± | æ‰€æœ‰ |
| `department` | âœ… | **é™¢ç³»åç§°ï¼ˆå¿…é¡»äº‹å…ˆå¯¼å…¥ï¼‰** | æ‰€æœ‰ |
| `major` | âŒ | ä¸“ä¸š | student |
| `grade` | âŒ | å¹´çº§ï¼ˆä¸å†å­˜å‚¨ï¼Œä»…ä¾›å‚è€ƒï¼‰ | student |
| `class_name` | âŒ | ç­çº§ï¼ˆä¸å†å­˜å‚¨ï¼Œä»…ä¾›å‚è€ƒï¼‰ | student |
| `title` | âŒ | èŒç§°ï¼ˆæ•™æˆ/å‰¯æ•™æˆ/è®²å¸ˆï¼‰ | teacher |

**ç¤ºä¾‹æ•°æ®**ï¼š
```csv
username,password,name,gender,role,role_no,phone,email,department,major,grade,class_name,title
admin100,Passw0rd!,å¼ ç»´å,ç”·,admin,A100,13800010100,zhangwh@edu.cn,æ•™åŠ¡å¤„,,,,,
teacher100,Passw0rd!,ç‹å»ºå›½,ç”·,teacher,T100,13800020100,wangjg@edu.cn,è½¯ä»¶å·¥ç¨‹å­¦é™¢,,,,æ•™æˆ
student100,Passw0rd!,èµµå¤©å®‡,ç”·,student,3123005001,13900030100,zhaoty@stu.edu.cn,è½¯ä»¶å·¥ç¨‹å­¦é™¢,è½¯ä»¶å·¥ç¨‹,2023,è½¯å·¥2301,
```

---

### 3. é‡è¦å˜æ›´è¯´æ˜

#### âš ï¸ æ•°æ®åº“ç»“æ„å˜æ›´

1. **æ–°å¢ Department è¡¨**ï¼š
   - `dept_id`ï¼ˆä¸»é”®ï¼‰
   - `dept_name`ï¼ˆå”¯ä¸€ï¼‰

2. **Users è¡¨å˜æ›´**ï¼š
   - ä¿ç•™ `real_name`ï¼ˆå­˜å‚¨ç”¨æˆ·çœŸå®å§“åï¼‰
   - CSV å¯¼å…¥æ—¶ä½¿ç”¨ `name` å­—æ®µæ˜ å°„åˆ° `real_name`

3. **Admin/Teacher/Student è¡¨å˜æ›´**ï¼š
   - âŒ åˆ é™¤å­—æ®µï¼š`name`, `department`ï¼ˆAdminï¼‰
   - âŒ åˆ é™¤å­—æ®µï¼š`name`, `gender`, `department`ï¼ˆTeacherï¼‰
   - âŒ åˆ é™¤å­—æ®µï¼š`name`, `gender`, `department`, `grade`, `class_name`ï¼ˆStudentï¼‰
   - âœ… æ–°å¢å­—æ®µï¼š`dept_id`ï¼ˆå¤–é”®ï¼Œå…³è” Department è¡¨ï¼‰
   - âœ… é€šè¿‡ `@property` æ–¹æ³•ä¿æŒå‘åå…¼å®¹ï¼š
     - `name` â†’ ä» `user.real_name` è·å–
     - `gender` â†’ ä» `user.real_name` è·å–ï¼ˆéœ€è¦ä» Users è¡¨æ‰©å±•ï¼‰
     - `department` â†’ ä» `department_info.dept_name` è·å–

4. **ç´¢å¼•åˆ é™¤**ï¼š
   - å·²åˆ é™¤ `idx_student_department`
   - å·²åˆ é™¤ `idx_teacher_department`
   - å·²åˆ é™¤ `idx_admin_department`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

---

### 4. å¯¼å…¥æµç¨‹

#### ğŸ“ æ­£ç¡®çš„å¯¼å…¥é¡ºåº

1. **ç¬¬ä¸€æ­¥ï¼šå¯¼å…¥é™¢ç³»**
   ```
   è®¿é—®ï¼šç®¡ç†å‘˜ä»ªè¡¨æ¿ â†’ æ‰¹é‡æ•°æ®å¯¼å…¥ â†’ æ‰¹é‡å¯¼å…¥é™¢ç³»
   ä¸Šä¼ æ–‡ä»¶ï¼šdepartments_import.csv
   ```

2. **ç¬¬äºŒæ­¥ï¼šå¯¼å…¥ç”¨æˆ·**
   ```
   è®¿é—®ï¼šç®¡ç†å‘˜ä»ªè¡¨æ¿ â†’ æ‰¹é‡æ•°æ®å¯¼å…¥ â†’ æ‰¹é‡å¯¼å…¥ç”¨æˆ·
   ä¸Šä¼ æ–‡ä»¶ï¼šusers_import_new.csv
   ```

3. **ç¬¬ä¸‰æ­¥ï¼šå¯¼å…¥è¯¾ç¨‹**
   ```
   è®¿é—®ï¼šç®¡ç†å‘˜ä»ªè¡¨æ¿ â†’ æ‰¹é‡æ•°æ®å¯¼å…¥ â†’ æ‰¹é‡å¯¼å…¥è¯¾ç¨‹
   ä¸Šä¼ æ–‡ä»¶ï¼šcourses_import_new.csv
   ```

4. **ç¬¬å››æ­¥ï¼šå¯¼å…¥æ•™å­¦ç­**
   ```
   è®¿é—®ï¼šç®¡ç†å‘˜ä»ªè¡¨æ¿ â†’ æ‰¹é‡æ•°æ®å¯¼å…¥ â†’ æ‰¹é‡å¯¼å…¥æ•™å­¦ç­
   ä¸Šä¼ æ–‡ä»¶ï¼šteaching_classes_import_new.csv
   ```

5. **ç¬¬äº”æ­¥ï¼šå¯¼å…¥æ•™å¸ˆä»»è¯¾**
   ```
   è®¿é—®ï¼šç®¡ç†å‘˜ä»ªè¡¨æ¿ â†’ æ‰¹é‡æ•°æ®å¯¼å…¥ â†’ æ‰¹é‡å¯¼å…¥æ•™å¸ˆä»»è¯¾
   ä¸Šä¼ æ–‡ä»¶ï¼šteacher_classes_import_new.csv
   ```

6. **ç¬¬å…­æ­¥ï¼šå¯¼å…¥å­¦ç”Ÿé€‰è¯¾**
   ```
   è®¿é—®ï¼šç®¡ç†å‘˜ä»ªè¡¨æ¿ â†’ æ‰¹é‡æ•°æ®å¯¼å…¥ â†’ æ‰¹é‡å¯¼å…¥å­¦ç”Ÿé€‰è¯¾
   ä¸Šä¼ æ–‡ä»¶ï¼šstudent_classes_import_new.csv
   ```

---

### 5. æµ‹è¯•æ•°æ®æ–‡ä»¶

å·²åˆ›å»ºä»¥ä¸‹æµ‹è¯•æ•°æ®æ–‡ä»¶ï¼ˆä½äº `test_import_samples/` ç›®å½•ï¼‰ï¼š

| æ–‡ä»¶å | è¯´æ˜ | è®°å½•æ•° |
|--------|------|--------|
| `departments_import.csv` | é™¢ç³»æ•°æ® | 7 ä¸ªé™¢ç³» |
| `users_import_new.csv` | ç”¨æˆ·æ•°æ® | 26 ä¸ªç”¨æˆ·ï¼ˆ2ç®¡ç†å‘˜+8æ•™å¸ˆ+16å­¦ç”Ÿï¼‰ |
| `courses_import_new.csv` | è¯¾ç¨‹æ•°æ® | 10 é—¨è¯¾ç¨‹ |
| `teaching_classes_import_new.csv` | æ•™å­¦ç­æ•°æ® | 13 ä¸ªæ•™å­¦ç­ |
| `teacher_classes_import_new.csv` | æ•™å¸ˆä»»è¯¾æ•°æ® | 15 æ¡è®°å½• |
| `student_classes_import_new.csv` | å­¦ç”Ÿé€‰è¯¾æ•°æ® | 37 æ¡è®°å½• |

---

### 6. é”™è¯¯å¤„ç†

å¯¼å…¥è¿‡ç¨‹ä¸­çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

1. **ä¿å­˜ç‚¹å›æ»š**ï¼šæ¯æ¡è®°å½•ä½¿ç”¨ç‹¬ç«‹çš„ä¿å­˜ç‚¹ï¼Œå•æ¡å¤±è´¥ä¸å½±å“å…¶ä»–è®°å½•
2. **è¯¦ç»†é”™è¯¯æŠ¥å‘Š**ï¼šå¤±è´¥è®°å½•ä¼šæ˜¾ç¤ºå…·ä½“åŸå› ï¼ˆè¡Œå·ã€ç”¨æˆ·åã€é”™è¯¯ä¿¡æ¯ï¼‰
3. **ç»Ÿè®¡ä¿¡æ¯**ï¼šæ˜¾ç¤ºæ€»è¡Œæ•°ã€æˆåŠŸæ•°ã€å¤±è´¥æ•°
4. **é™¢ç³»æ£€æŸ¥**ï¼šè‡ªåŠ¨éªŒè¯é™¢ç³»æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æŠ¥é”™

---

### 7. ä»£ç å˜æ›´ä½ç½®

#### app.py
- **æ–°å¢å‡½æ•°**ï¼š`admin_import_departments()`ï¼ˆç¬¬ 686-750 è¡Œï¼‰
- **ä¿®æ”¹å‡½æ•°**ï¼š`admin_batch_import()`ï¼ˆç¬¬ 798-900 è¡Œï¼‰
  - å­—æ®µåä» `real_name` æ”¹ä¸º `name`
  - æ–°å¢ `gender` å­—æ®µéªŒè¯
  - å¼ºåˆ¶è¦æ±‚ `department` å­—æ®µ
  - ç»Ÿä¸€å¤„ç† `dept_id`

#### templates/admin_dashboard.html
- **æ–°å¢å¡ç‰‡**ï¼šé™¢ç³»å¯¼å…¥å…¥å£ï¼ˆç¬¬ä¸€ä¸ªå¯¼å…¥é€‰é¡¹ï¼‰

#### templates/admin_batch_import.html
- **æ›´æ–°è¯´æ˜**ï¼šCSV æ ¼å¼è¦æ±‚å’Œå­—æ®µè¯´æ˜
- **æ–°å¢ç¤ºä¾‹**ï¼šå®Œæ•´çš„ CSV ç¤ºä¾‹æ•°æ®

#### æ–°å¢æ–‡ä»¶
- `templates/admin_import_departments.html`ï¼šé™¢ç³»å¯¼å…¥æ¨¡æ¿

---

### 8. æ³¨æ„äº‹é¡¹

âš ï¸ **å¯¼å…¥å‰å¿…è¯»**ï¼š

1. **CSV æ–‡ä»¶ç¼–ç **ï¼šå»ºè®®ä½¿ç”¨ UTF-8 with BOM
2. **å¿…é¡»å…ˆå¯¼å…¥é™¢ç³»**ï¼šå¦åˆ™ç”¨æˆ·å¯¼å…¥ä¼šå› ä¸ºæ‰¾ä¸åˆ°é™¢ç³»è€Œå¤±è´¥
3. **å”¯ä¸€æ€§çº¦æŸ**ï¼š
   - ç”¨æˆ·åï¼ˆusernameï¼‰ä¸èƒ½é‡å¤
   - å·¥å·/å­¦å·ï¼ˆrole_noï¼‰ä¸èƒ½é‡å¤
   - é™¢ç³»åç§°ï¼ˆdept_nameï¼‰ä¸èƒ½é‡å¤
4. **è§’è‰²å€¼å¿…é¡»å°å†™**ï¼šadmin, teacher, student
5. **grade å’Œ class_name**ï¼šè¿™ä¸¤ä¸ªå­—æ®µä»å¯åœ¨ CSV ä¸­å¡«å†™ï¼Œä½†ä¸ä¼šå­˜å‚¨åˆ°æ•°æ®åº“ï¼ˆä»…ç”¨äºè¿ç§»å…¼å®¹ï¼‰

---

### 9. å‘åå…¼å®¹æ€§

é€šè¿‡ `@property` æ–¹æ³•ä¿æŒå‘åå…¼å®¹ï¼š

```python
# åœ¨ Student/Teacher/Admin ç±»ä¸­
@property
def name(self):
    return self.user.real_name if self.user else None

@property
def department(self):
    return self.department_info.dept_name if self.department_info else None
```

è¿™æ ·ç°æœ‰çš„æ¨¡æ¿ä»£ç ä»ç„¶å¯ä»¥ä½¿ç”¨ `student.name` å’Œ `student.department`ã€‚

---

## âœ… éªŒè¯æ¸…å•

å¯¼å…¥å®Œæˆåï¼Œè¯·éªŒè¯ï¼š

- [ ] Department è¡¨åŒ…å«æ‰€æœ‰é™¢ç³»
- [ ] Users è¡¨çš„ real_name å­—æ®µå·²æ­£ç¡®å¡«å……
- [ ] Admin/Teacher/Student è¡¨çš„ dept_id å­—æ®µå·²æ­£ç¡®å…³è”
- [ ] Admin/Teacher/Student è¡¨ä¸å†åŒ…å« name, department ç­‰å†—ä½™å­—æ®µ
- [ ] ç”¨æˆ·ç™»å½•åèƒ½æ­£ç¡®æ˜¾ç¤ºå§“åå’Œé™¢ç³»ä¿¡æ¯

---

**æ›´æ–°æ—¥æœŸ**: 2025å¹´12æœˆ25æ—¥  
**æ•°æ®åº“ç‰ˆæœ¬**: 3NFï¼ˆç¬¬ä¸‰èŒƒå¼ï¼‰  
**ç›¸å…³æ–‡æ¡£**: 
- [æ•°æ®åº“è§„èŒƒåŒ–åˆ†ææŠ¥å‘Š.md](æ•°æ®åº“è§„èŒƒåŒ–åˆ†ææŠ¥å‘Š.md)
- [æ•°æ®åº“è§„èŒƒåŒ–å®æ–½è¯´æ˜.md](æ•°æ®åº“è§„èŒƒåŒ–å®æ–½è¯´æ˜.md)
- [æƒé™ç®¡ç†æ›´æ–°è¯´æ˜.md](æƒé™ç®¡ç†æ›´æ–°è¯´æ˜.md)
