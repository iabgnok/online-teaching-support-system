# æ•°æ®åº“è®¾è®¡è§„èŒƒåŒ–åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦
æ‚¨çš„åœ¨çº¿æ•™å­¦æ”¯æŒç³»ç»Ÿæ•°æ®åº“è®¾è®¡**æ•´ä½“è§„èŒƒåŒ–ç¨‹åº¦è¾ƒå¥½**ï¼Œå·²è¾¾åˆ° **3NFï¼ˆç¬¬ä¸‰èŒƒå¼ï¼‰** æ°´å¹³ã€‚ä½†å­˜åœ¨å‡ ä¸ªå¯æ”¹è¿›çš„åœ°æ–¹ã€‚

---

## 1. è§„èŒƒåŒ–çº§åˆ«è¯„ä¼°

### âœ… å·²æ»¡è¶³çš„èŒƒå¼è¦æ±‚

#### ç¬¬ä¸€èŒƒå¼ï¼ˆ1NFï¼‰- **å®Œå…¨æ»¡è¶³**
- æ‰€æœ‰å±æ€§éƒ½æ˜¯åŸå­å€¼
- æ²¡æœ‰é‡å¤çš„ç»„æˆ–æ•°ç»„
- æ¯ä¸ªå­—æ®µéƒ½æ˜¯å•ä¸€å€¼

#### ç¬¬äºŒèŒƒå¼ï¼ˆ2NFï¼‰- **å®Œå…¨æ»¡è¶³**
- æ‰€æœ‰éä¸»é”®å±æ€§å®Œå…¨ä¾èµ–äºä¸»é”®
- æ¶ˆé™¤äº†éƒ¨åˆ†ä¾èµ–å…³ç³»
- å¤šå¯¹å¤šå…³ç³»ä½¿ç”¨äº†å…³è”è¡¨ï¼ˆStudentClass, TeacherClassï¼‰

#### ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰- **åŸºæœ¬æ»¡è¶³ï¼Œä½†æœ‰ç‘•ç–µ**
- å¤§éƒ¨åˆ†è¡¨å·²æ¶ˆé™¤ä¼ é€’ä¾èµ–
- ä¸»é”®è®¾è®¡æ¸…æ™°ï¼Œå¤–é”®å…³ç³»è§„èŒƒ

---

## 2. å‘ç°çš„è§„èŒƒåŒ–é—®é¢˜

### ğŸ”´ ä¸¥é‡é—®é¢˜

#### é—®é¢˜ 1ï¼šStudent è¡¨ä¸­å­˜åœ¨æ•°æ®å†—ä½™
**ä½ç½®**: [Student è¡¨](models.py#L95-L108)

**é—®é¢˜æè¿°**:
```python
class Student(db.Model):
    # ... å…¶ä»–å­—æ®µ ...
    name = db.Column(db.String(50), nullable=False)
    gender = db.Column(db.String(10))
    department = db.Column(db.String(100))
    # âš ï¸ real_name å·²åœ¨ Users è¡¨ä¸­å­˜å‚¨
    # âš ï¸ department ç­‰ä¿¡æ¯é‡å¤ï¼Œéƒ¨é—¨ä¿¡æ¯åº”å•ç‹¬è¡¨ç®¡ç†
```

**é—®é¢˜åˆ†æ**:
- `name` åœ¨ Student å’Œ Users è¡¨ä¸­éƒ½å­˜å‚¨ï¼ˆUsers ä¸­æ˜¯ `real_name`ï¼‰
- `department` åœ¨ Student å’Œ Teacher è¡¨ä¸­éƒ½æœ‰ï¼Œåº”åˆ›å»º Department è¡¨
- `grade`, `class_name` æ˜¯å­¦æœŸç‰¹å®šçš„ï¼Œåº”è¯¥åœ¨å…³è”è¡¨ä¸­

**è¿åèŒƒå¼**: è¿åç¬¬ä¸‰èŒƒå¼ï¼ˆå­˜åœ¨éä¸»é”®å±æ€§çš„ä¼ é€’ä¾èµ–ï¼‰

**æ”¹è¿›å»ºè®®**:
```python
# æ–°å»º Department è¡¨
class Department(db.Model):
    __tablename__ = 'Department'
    dept_id = db.Column(db.BigInteger, primary_key=True)
    dept_name = db.Column(db.String(100), unique=True, nullable=False)
    description = db.Column(db.Text)

# æ”¹è¿›åçš„ Student è¡¨
class Student(db.Model):
    student_id = db.Column(db.BigInteger, primary_key=True)
    user_id = db.Column(db.BigInteger, db.ForeignKey('Users.user_id'))
    student_no = db.Column(db.String(10), unique=True, nullable=False)
    dept_id = db.Column(db.BigInteger, db.ForeignKey('Department.dept_id'))
    major = db.Column(db.String(100))
    # åˆ é™¤ï¼šname, gender, department, grade, class_name
    # è¿™äº›ä¿¡æ¯åº”ä»å…³è”è¡¨æˆ–Usersè¡¨è·å–
```

---

#### é—®é¢˜ 2ï¼šStudent è¡¨ä¸­çš„ grade å’Œ class_name æ˜¯å˜åŠ¨çš„å±æ€§
**ä½ç½®**: [Student è¡¨](models.py#L103-L104)

**é—®é¢˜æè¿°**:
```python
grade = db.Column(db.String(20))          # è¿™ä¼šå˜åŒ–
class_name = db.Column(db.String(50))     # è¿™ä¹Ÿä¼šå˜åŒ–
```

**é—®é¢˜åˆ†æ**:
- `grade`ï¼ˆå¹´çº§ï¼‰ä¼šéšæ—¶é—´å˜åŒ–ï¼Œä¸åº”åœ¨ Student è¡¨ä¸­å›ºå®šå­˜å‚¨
- `class_name` åº”å­˜å‚¨åœ¨ StudentClass å…³è”è¡¨ä¸­
- è¿™å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é£é™©

**æ”¹è¿›å»ºè®®**:
```python
class StudentClass(db.Model):
    id = db.Column(db.BigInteger, primary_key=True)
    student_id = db.Column(db.BigInteger, db.ForeignKey('Student.student_id'))
    class_id = db.Column(db.BigInteger, db.ForeignKey('TeachingClass.class_id'))
    grade = db.Column(db.String(20))      # âœ… ç§»åˆ°è¿™é‡Œ
    enroll_time = db.Column(db.DateTime())
    # å¦‚æœéœ€è¦ï¼Œä¹Ÿå¯åœ¨TeachingClassä¸­å­˜å‚¨
```

---

#### é—®é¢˜ 3ï¼šTeacher è¡¨ä¸­çš„ department åº”è¯¥è§„èŒƒåŒ–
**ä½ç½®**: [Teacher è¡¨](models.py#L120)

**é—®é¢˜æè¿°**:
```python
class Teacher(db.Model):
    # ...
    department = db.Column(db.String(100))
```

**æ”¹è¿›å»ºè®®**:
```python
class Teacher(db.Model):
    teacher_id = db.Column(db.BigInteger, primary_key=True)
    user_id = db.Column(db.BigInteger, db.ForeignKey('Users.user_id'))
    teacher_no = db.Column(db.String(20), unique=True)
    dept_id = db.Column(db.BigInteger, db.ForeignKey('Department.dept_id'))
    title = db.Column(db.String(50))
    # åˆ é™¤ï¼šdepartmentï¼ˆæ”¹ä¸º dept_id å¤–é”®ï¼‰
```

---



#### é—®é¢˜ 4ï¼šé‡å¤çš„ç”¨æˆ·å±æ€§
**ä½ç½®**: [Studentã€Teacherã€Admin è¡¨](models.py)

**é—®é¢˜æè¿°**:
```
Users è¡¨: username, real_name, phone, email, role, status
Student è¡¨: name (é‡å¤ real_name)
Teacher è¡¨: name (é‡å¤ real_name)
Admin è¡¨: name (é‡å¤ real_name)
```

**æ”¹è¿›å»ºè®®**:
- åˆ é™¤ Studentã€Teacherã€Admin è¡¨ä¸­çš„ `name` å­—æ®µ
- ä½¿ç”¨ `Users.real_name` ä½œä¸ºå”¯ä¸€æ¥æº
- é€šè¿‡ ORM çš„ relationship è·å–

```python
# åœ¨åº”ç”¨å±‚è·å–
student = Student.query.get(id)
student_name = student.user.real_name  # âœ… æ¥è‡ª Users è¡¨
```

---
### ğŸŸ¡ ä¸­ç­‰é—®é¢˜
#### é—®é¢˜ 5ï¼šAdmin è¡¨æƒé™è®¾è®¡ä¸è§„èŒƒ
**ä½ç½®**: [Admin è¡¨](models.py#L77)

**é—®é¢˜æè¿°**:
```python
class Admin(db.Model):
    permission_level = db.Column(db.SmallInteger, default=3)
```

**é—®é¢˜åˆ†æ**:
- æƒé™æ•°æ®å­˜å‚¨åœ¨å•ä¸ªæ•´æ•°å­—æ®µä¸­
- æ— æ³•çµæ´»ç®¡ç†å¤šä¸ªæƒé™
- ä¸ç¬¦åˆæƒé™ç®¡ç†æœ€ä½³å®è·µ

**æ”¹è¿›å»ºè®®**:
```python
class Permission(db.Model):
    __tablename__ = 'Permission'
    permission_id = db.Column(db.BigInteger, primary_key=True)
    permission_name = db.Column(db.String(50), unique=True)  # 'user_management', 'permission_management'
    description = db.Column(db.Text)

class AdminPermission(db.Model):
    __tablename__ = 'AdminPermission'
    id = db.Column(db.BigInteger, primary_key=True)
    admin_id = db.Column(db.BigInteger, db.ForeignKey('Admin.admin_id'))
    permission_id = db.Column(db.BigInteger, db.ForeignKey('Permission.permission_id'))
    __table_args__ = (
        db.UniqueConstraint('admin_id', 'permission_id'),
    )
```

---

### ğŸŸ¢ è½»å¾®é—®é¢˜

#### é—®é¢˜ 6ï¼šGrade è¡¨çš„è®¾è®¡å¯ä»¥ä¼˜åŒ–
**ä½ç½®**: [Grade è¡¨](models.py#L304-L321)

**è§‚å¯Ÿ**:
```python
class Grade(db.Model):
    homework_avg = db.Column(db.Numeric(5, 2))
    exam_avg = db.Column(db.Numeric(5, 2))
    teacher_evaluation = db.Column(db.Numeric(5, 2))
    final_grade = db.Column(db.Numeric(5, 2))
```

**æ½œåœ¨é—®é¢˜**:
- å¤šä¸ªæˆç»©å­—æ®µï¼Œå¦‚æœè¯„åˆ†æ–¹å¼æ”¹å˜ï¼Œéœ€è¦ä¿®æ”¹è¡¨ç»“æ„
- `final_grade` æ˜¯è®¡ç®—å‡ºæ¥çš„ï¼ˆéç‹¬ç«‹æ•°æ®ï¼‰ï¼Œåº”è¯¥é€šè¿‡è§†å›¾è®¡ç®—è€Œä¸æ˜¯å­˜å‚¨

**æ”¹è¿›å»ºè®®**:
```python
class Grade(db.Model):
    homework_avg = db.Column(db.Numeric(5, 2))
    exam_avg = db.Column(db.Numeric(5, 2))
    teacher_evaluation = db.Column(db.Numeric(5, 2))
    # åˆ é™¤ final_gradeï¼Œé€šè¿‡æ•°æ®åº“è§†å›¾æˆ–åº”ç”¨å±‚è®¡ç®—
    
    @property
    def final_grade(self):
        # è®¡ç®—æœ€ç»ˆæˆç»©ï¼Œè€Œä¸æ˜¯å­˜å‚¨
        return (self.homework_avg * 0.3 + 
                self.exam_avg * 0.5 + 
                self.teacher_evaluation * 0.2)
```

---

## 3. è§„èŒƒåŒ–é—®é¢˜æ±‡æ€»è¡¨

| åºå· | é—®é¢˜ | ä¸¥é‡åº¦ | è¿åèŒƒå¼ | å½±å“ |
|------|------|--------|---------|------|
| 1 | Student/Teacher ä¸­ name é‡å¤ | ğŸ”´ | 3NF | æ•°æ®ä¸ä¸€è‡´é£é™© |
| 2 | Student çš„ department åº”è§„èŒƒåŒ– | ğŸ”´ | 3NF | ç»´æŠ¤å›°éš¾ |
| 3 | Student çš„ grade, class_name ä½ç½®é”™è¯¯ | ğŸ”´ | 2NF | æ•°æ®å†—ä½™ |
| 4 | Teacher çš„ department åº”è§„èŒƒåŒ– | ğŸ”´ | 3NF | ç»´æŠ¤å›°éš¾ |
| 5 | Admin æƒé™è®¾è®¡è¿‡äºç®€å• | ğŸŸ¡ | ä¸šåŠ¡è§„èŒƒ | åŠŸèƒ½å—é™ |
| 6 | Grade ä¸­ final_grade ä¸åº”å­˜å‚¨ | ğŸŸ¡ | 3NF | æ•°æ®å†—ä½™ |

---

## 4. æ”¹è¿›æ–¹æ¡ˆï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼ˆå¿…åšï¼‰- ä¿®å¤ 3NF è¿å

1. **åˆ›å»º Department è¡¨**
   ```sql
   CREATE TABLE Department (
       dept_id BIGINT PRIMARY KEY,
       dept_name NVARCHAR(100) UNIQUE NOT NULL,
       description NVARCHAR(MAX)
   );
   ```

2. **åˆ é™¤é‡å¤çš„ name å­—æ®µ**
   - ä» Studentã€Teacherã€Admin ä¸­åˆ é™¤ `name`
   - æ‰€æœ‰åå­—æŸ¥è¯¢é€šè¿‡ User.real_name

3. **ä¿®æ­£ grade å’Œ class_name çš„å­˜å‚¨ä½ç½®**
   - ä» Student è¡¨ä¸­åˆ é™¤
   - ä¿å­˜åœ¨ StudentClass è¡¨ä¸­ï¼ˆå¦‚éœ€è¦ï¼‰

---

### ç¬¬äºŒé˜¶æ®µï¼ˆæ¨èï¼‰- ä¼˜åŒ–ä¸šåŠ¡è®¾è®¡

4. **é‡æ„æƒé™ç®¡ç†**
   - åˆ›å»º Permission å’Œ AdminPermission è¡¨
   - æ”¯æŒæ›´çµæ´»çš„æƒé™ç®¡ç†

5. **ä¼˜åŒ–æˆç»©è®¡ç®—**
   - åˆ é™¤ final_grade å­—æ®µï¼Œæ”¹ç”¨æ•°æ®åº“è§†å›¾æˆ–åº”ç”¨è®¡ç®—
   - ä¿ç•™å®¡è®¡å­—æ®µï¼ˆcalculated_by, calculated_atï¼‰

---

## 5. ç°æœ‰ä¼˜ç‚¹ï¼ˆä¿æŒï¼‰

âœ… **å¤šå¯¹å¤šå…³ç³»å¤„ç†è§„èŒƒ**
- StudentClass å’Œ TeacherClass éƒ½æ˜¯æ ‡å‡†çš„å…³è”è¡¨
- æœ‰è”åˆå”¯ä¸€çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§

âœ… **å¤–é”®çº¦æŸå®Œæ•´**
- æ‰€æœ‰å…³ç³»éƒ½æœ‰æ˜ç¡®çš„å¤–é”®
- æ”¯æŒå‚è€ƒå®Œæ•´æ€§

âœ… **æ—¶é—´æˆ³å®¡è®¡å­—æ®µ**
- created_at å’Œ updated_at çš„ä½¿ç”¨
- ä¾¿äºè¿½è¸ªæ•°æ®å˜åŒ–

âœ… **CHECK çº¦æŸä½¿ç”¨**
- role, status, type ç­‰å­—æ®µæœ‰çº¦æŸ
- é™åˆ¶äº†éæ³•å€¼çš„è¾“å…¥

âœ… **å”¯ä¸€çº¦æŸåˆç†**
- username, student_no, teacher_no, course_code ç­‰å”¯ä¸€
- ä¿è¯äº†æ•°æ®çš„å”¯ä¸€æ€§

---

## 6. å®æ–½å»ºè®®

### å¿«é€Ÿä¿®å¤ï¼ˆç«‹å³å¯åšï¼‰
```python
# åœ¨ models.py ä¸­åˆ é™¤å†—ä½™å­—æ®µï¼š
# Student.name â†’ æ”¹ç”¨ User.real_name
# Teacher.name â†’ æ”¹ç”¨ User.real_name  
# Admin.name â†’ æ”¹ç”¨ User.real_name

# æ·»åŠ  Department è¡¨
class Department(db.Model):
    __tablename__ = 'Department'
    dept_id = db.Column(db.BigInteger, primary_key=True)
    dept_name = db.Column(db.String(100), unique=True, nullable=False)
    description = db.Column(db.Text)
    created_at = db.Column(db.DateTime(timezone=True), default=func.now())
```

### æ•°æ®è¿ç§»è„šæœ¬
å»ºè®®åœ¨ `migrate_permissions.py` ä¹‹ååˆ›å»º `normalize_database.py` è„šæœ¬æ‰§è¡Œè¿ç§»

---

## æ€»ä½“è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | å¤‡æ³¨ |
|------|------|------|
| è§„èŒƒåŒ–æ°´å¹³ | 7.5/10 | è¾¾åˆ° 3NFï¼Œä½†å­˜åœ¨æ”¹è¿›ç©ºé—´ |
| æ•°æ®å®Œæ•´æ€§ | 8/10 | å¤–é”®å’Œçº¦æŸè®¾ç½®å®Œå–„ |
| å¯ç»´æŠ¤æ€§ | 6.5/10 | å†—ä½™å­—æ®µå½±å“ç»´æŠ¤ |
| æ‰©å±•æ€§ | 7/10 | æƒé™ç®¡ç†éœ€è¦ä¼˜åŒ– |
| **æ€»ä½“** | **7.5/10** | è‰¯å¥½ï¼Œéœ€è¦ä¼˜åŒ–ç»†èŠ‚ |

---

## å‚è€ƒèµ„æº

- [æ•°æ®åº“è§„èŒƒåŒ–](https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A7%84%E8%8C%83%E5%8C%96)
- [ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰](https://en.wikipedia.org/wiki/Third_normal_form)
- [å…³è”è¡¨æœ€ä½³å®è·µ](https://use-the-index-luke.com/sql/join)
