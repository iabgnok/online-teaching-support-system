# 阶段三管理员端迁移 - 功能演示指南

## 🎯 核心成果

本次迁移实现了管理员端的完全前后端分离，提供了完整的用户管理、数据导入、统计查询等功能。

## 🚀 快速开始

### 1. 启动后端服务
```bash
cd e:\online_teaching_support_system
python app.py
```

### 2. 启动前端服务
```bash
cd frontend
npm run dev
```

### 3. 访问管理员端
- URL: `http://localhost:5173/admin/dashboard`
- 使用管理员账户登录后自动跳转

## 📊 功能模块演示

### 模块1：管理员仪表盘
**路径**: `/admin/dashboard`

**功能展示**：
1. **统计卡片**
   - 总用户数（管理员/教师/学生分类）
   - 课程数和教学班数
   - 作业数和提交数
   - 考勤场次数

2. **用户统计表格**
   - 按院系分类显示
   - 实时更新数据
   - 支持跳转到详细管理

3. **系统公告管理**
   - 查看最新公告
   - 发布新公告
   - 公告发布后所有用户可见

4. **快速操作**
   - 创建用户：一键跳转到用户创建
   - 批量导入：弹出导入对话框
   - 数据查询：跳转到查询页面

**API调用**：
```javascript
GET /api/v1/admin/dashboard/stats
```

**响应示例**：
```json
{
  "users": {
    "admins": 5,
    "teachers": 50,
    "students": 500,
    "total": 555
  },
  "courses": {
    "courses": 30,
    "teaching_classes": 45
  },
  "activities": {
    "assignments": 120,
    "submissions": 3500,
    "attendance_sessions": 200
  },
  "announcements": [...],
  "user_stats_by_dept": [...]
}
```

---

### 模块2：用户管理
**路径**: `/admin/users`

**核心功能**：

#### 2.1 用户列表
- ✅ 分页展示（20/50/100条每页）
- ✅ 多条件筛选：
  - 角色（管理员/教师/学生）
  - 状态（激活/禁用）
  - 姓名模糊搜索
  - 用户名模糊搜索
- ✅ 表格展示：
  - 用户ID、用户名、真实姓名
  - 角色（彩色标签）
  - 角色特定信息（工号/学号/编号、院系）
  - 状态（激活/禁用标签）
  - 联系方式（电话、邮箱）
  - 操作按钮（编辑、切换状态、删除）

**API调用**：
```javascript
GET /api/v1/admin/users?page=1&per_page=20&role=student&status=1
```

#### 2.2 创建用户
**步骤**：
1. 点击"创建用户"按钮
2. 填写基本信息：
   - 用户名（必填，唯一）
   - 密码（必填）
   - 真实姓名（必填）
   - 角色（必选：管理员/教师/学生）
3. 根据角色填写特定信息：
   - **管理员**：管理员编号、权限等级（1/2/3）
   - **教师**：教师工号、职称
   - **学生**：学生学号、专业
4. 选择院系（下拉选择）
5. 填写联系方式（可选）

**API调用**：
```javascript
POST /api/v1/admin/users
{
  "username": "student202401",
  "password": "123456",
  "real_name": "张三",
  "role": "student",
  "student_no": "202401001",
  "dept_id": 1,
  "major": "计算机科学",
  "phone": "13800138000",
  "email": "zhangsan@example.com"
}
```

#### 2.3 编辑用户
- 点击用户行的"编辑"按钮
- 预填充当前用户信息
- 密码字段留空表示不修改
- 角色不可更改（需删除后重建）

**API调用**：
```javascript
PUT /api/v1/admin/users/123
{
  "real_name": "李四",
  "phone": "13900139000"
}
```

#### 2.4 切换用户状态
- 激活 → 禁用：用户无法登录
- 禁用 → 激活：恢复登录权限
- 不能禁用自己
- 不能禁用超级管理员

**API调用**：
```javascript
POST /api/v1/admin/users/123/toggle-status
```

#### 2.5 删除用户
- 弹出确认对话框
- 级联删除所有相关数据：
  - 学生：选课记录、作业提交、成绩、考勤
  - 教师：创建的作业、上传的资料、任课记录
  - 管理员：管理员记录
- 不能删除自己
- 不能删除超级管理员

**API调用**：
```javascript
DELETE /api/v1/admin/users/123
```

---

### 模块3：批量数据导入
**入口**: 仪表盘"批量导入"按钮

**支持的导入类型**：

#### 3.1 用户导入
**CSV格式**：
```csv
username,password,real_name,role,phone,email,admin_no,teacher_no,student_no,department,title,major,permission_level
admin001,123456,管理员1,admin,13800000001,admin1@ex.com,A001,,,计算机学院,,,2
teacher001,123456,教师1,teacher,13800000002,t1@ex.com,,T001,,数学学院,教授,,
student001,123456,学生1,student,13800000003,s1@ex.com,,,S001,物理学院,,物理学,
```

**API调用**：
```javascript
POST /api/v1/admin/import/users
Content-Type: multipart/form-data
file: users.csv
```

**响应示例**：
```json
{
  "message": "Import completed: 100 success, 5 errors",
  "success_count": 100,
  "error_count": 5,
  "errors": [
    "Row 3: Username 'admin001' already exists",
    "Row 7: Missing required fields",
    ...
  ]
}
```

#### 3.2 院系导入
**CSV格式**：
```csv
dept_name
计算机学院
数学学院
物理学院
化学学院
```

**API调用**：
```javascript
POST /api/v1/admin/import/departments
```

#### 3.3 课程导入
**CSV格式**：
```csv
course_code,course_name,credits,description
CS101,数据结构,4,计算机科学基础课程
MATH201,高等数学,5,理工科必修课程
PHYS101,大学物理,4,物理学基础
```

**API调用**：
```javascript
POST /api/v1/admin/import/courses
```

---

### 模块4：数据查询与统计
**路径**: `/admin/query`

#### 4.1 用户查询
**功能**：
- 用户名模糊搜索
- 真实姓名模糊搜索
- 角色筛选
- 状态筛选
- 结果表格展示
- 导出为CSV

**API调用**：
```javascript
POST /api/v1/admin/query/users
{
  "username": "student",
  "role": "student",
  "status": 1
}
```

**导出功能**：
```javascript
GET /api/v1/admin/export/users?role=student
```
自动下载CSV文件

#### 4.2 课程查询
**功能**：
- 课程代码模糊搜索
- 课程名称模糊搜索
- 结果表格展示

**API调用**：
```javascript
POST /api/v1/admin/query/courses
{
  "course_code": "CS",
  "course_name": "数据"
}
```

#### 4.3 统计报表
**用户统计（按院系）**：
- 显示每个院系的管理员、教师、学生数量
- 合计列

**API调用**：
```javascript
GET /api/v1/admin/stats/users
```

**课程统计**：
- 课程名称
- 教学班数量
- 学生数量
- 作业数量

**API调用**：
```javascript
GET /api/v1/admin/stats/courses
```

---

### 模块5：权限管理
**路径**: 仪表盘"权限管理"（需Level 1权限）

**功能**：
- 查看所有管理员列表
- 显示权限等级
- 修改管理员权限等级（1/2/3）
- 不能修改超级管理员

**API调用**：
```javascript
GET /api/v1/admin/permissions

PUT /api/v1/admin/permissions/5
{
  "permission_level": 2
}
```

---

## 🔗 与其他模块的联动

### 1. 与学生端联动
**场景1：创建学生账户**
```
管理员 → 创建学生 → 学生登录 → 自动显示已选课程
```

**场景2：查看学生成绩**
```
管理员 → 数据查询 → 查看某学生 → 可以看到成绩记录（使用已有grades API）
```

**场景3：处理学生问题**
```
学生提交作业失败 → 管理员检查学生账户状态 → 发现被禁用 → 激活账户
```

### 2. 与教师端联动
**场景1：分配教师**
```
管理员 → 创建教师账户 → 导入任课关系 → 教师登录查看教学班
```

**场景2：教师离职处理**
```
管理员 → 删除教师 → 自动清理作业、资料 → 任课记录归档
```

**场景3：权限管理**
```
教师创建作业 → 管理员可以查看统计 → 如需删除，级联处理提交记录
```

### 3. 全局联动
**公告系统**：
```
管理员发布全局公告 → 所有角色仪表盘显示
```

**消息系统**：
```
管理员 → 站内信 → 选择教师/学生 → 发送通知
```

**统计报表**：
```
管理员查看全局数据 → 包含学生作业提交、教师批改、考勤记录等
```

---

## 🛡️ 权限体系说明

### 权限等级
1. **Level 1（最高权限）**：
   - 修改其他管理员权限
   - 所有Level 2和3的权限

2. **Level 2（中等权限）**：
   - 用户CRUD操作
   - 批量数据导入
   - 所有Level 3的权限

3. **Level 3（普通权限）**：
   - 查看统计数据
   - 数据查询
   - 只读操作

### 特殊保护
- **超级管理员**（首个创建的管理员）：
  - 自动获得Level 1权限
  - 不能被删除
  - 不能被禁用
  - 不能修改其权限

---

## 📝 测试清单

### 后端API测试
```bash
# 运行测试脚本
cd 脚本
python test_admin_api.py
```

### 前端功能测试
- [ ] 登录后自动跳转到管理员仪表盘
- [ ] 仪表盘统计卡片数据正确
- [ ] 用户列表分页和筛选正常
- [ ] 创建用户成功（三种角色）
- [ ] 编辑用户信息生效
- [ ] 切换用户状态生效
- [ ] 删除用户及级联删除正常
- [ ] CSV导入成功（用户、院系、课程）
- [ ] 数据查询返回正确结果
- [ ] CSV导出下载正常
- [ ] 统计报表数据准确
- [ ] 权限管理功能正常
- [ ] 发布公告成功

### 权限测试
- [ ] Level 3管理员不能修改权限
- [ ] Level 2管理员不能修改权限
- [ ] Level 1管理员可以修改其他管理员权限
- [ ] 不能修改超级管理员权限
- [ ] 不能删除超级管理员
- [ ] 不能禁用自己的账户

---

## 🎨 界面预览

### 1. 管理员仪表盘
```
┌─────────────────────────────────────────────┐
│  🛡️ 管理员控制台                             │
│  欢迎回来，张三管理员                         │
│  2026年1月16日 星期四 14:30                   │
│  [创建用户] [批量导入] [数据查询]              │
└─────────────────────────────────────────────┘

┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐
│ 555  │ │  30  │ │ 120  │ │ 200  │
│ 总用户│ │ 课程  │ │ 作业  │ │考勤  │
└──────┘ └──────┘ └──────┘ └──────┘

┌────────────────┐ ┌────────────────┐
│ 用户统计（院系）│ │ 系统公告        │
│ 计算机学院: 200 │ │ • 系统维护通知  │
│ 数学学院: 150   │ │ • 期末安排      │
│ 物理学院: 100   │ │ • 新功能上线    │
└────────────────┘ └────────────────┘
```

### 2. 用户管理界面
```
┌─────────────────────────────────────────────┐
│  👥 用户管理              [创建用户]          │
├─────────────────────────────────────────────┤
│ 角色:[全部▼] 状态:[全部▼]                   │
│ 姓名:[____] 用户名:[____] [搜索] [重置]      │
├──┬────────┬──────┬──────┬──────┬────────────┤
│ID│ 用户名  │ 姓名  │ 角色  │ 状态 │ 操作       │
├──┼────────┼──────┼──────┼──────┼────────────┤
│1 │admin001│张三   │管理员 │激活  │编辑/禁用/删│
│2 │teach001│李四   │教师   │激活  │编辑/禁用/删│
│3 │stud001 │王五   │学生   │激活  │编辑/禁用/删│
└──┴────────┴──────┴──────┴──────┴────────────┘
                    [1] 2 3 ... 共28页
```

### 3. 数据查询界面
```
┌─────────────────────────────────────────────┐
│  📊 数据查询与统计                            │
├─────────────────────────────────────────────┤
│ [用户查询] [课程查询] [统计报表]              │
├─────────────────────────────────────────────┤
│ 用户名:[____] 姓名:[____] 角色:[全部▼]       │
│ [查询] [导出]                                 │
├─────────────────────────────────────────────┤
│ 查询结果: 150 条记录                          │
│ [表格展示...]                                 │
└─────────────────────────────────────────────┘
```

---

## 💡 使用技巧

1. **快速筛选**：用户管理页面支持组合筛选，可同时按角色、状态、姓名搜索

2. **批量导入**：准备好CSV文件后，可以一次性导入多个用户，失败的行会显示错误原因

3. **数据导出**：查询结果可以导出为CSV，方便在Excel中进一步分析

4. **权限分配**：新创建的管理员默认是Level 3权限，可以根据需要提升

5. **安全删除**：删除用户前会自动检查关联数据，并给出提示

---

## 🔧 故障排查

### 问题1：API返回403 Forbidden
**原因**：权限不足或未登录
**解决**：
1. 确认使用管理员账户登录
2. 检查权限等级是否满足要求
3. 清除浏览器Cookie重新登录

### 问题2：CSV导入失败
**原因**：格式不正确或编码问题
**解决**：
1. 确保CSV文件使用UTF-8编码
2. 检查必填字段是否完整
3. 查看返回的错误消息

### 问题3：统计数据不准确
**原因**：数据库视图未更新
**解决**：
```sql
-- 刷新视图（如果需要）
-- 通常视图是实时计算的，不需要手动刷新
```

---

## 📚 相关文档

- [阶段三完成报告](PHASE_3_COMPLETION.md)
- [项目更新计划](PROJECT_UPDATE_PLAN.md)
- [阶段二完成报告](PHASE_2_COMPLETION.md)
- [成绩系统指南](GRADE_SYSTEM_GUIDE.md)

---

## ✅ 总结

阶段三管理员端迁移实现了完整的管理功能，与学生端、教师端形成了完整的三端分离架构。所有核心业务逻辑已API化，为未来的移动端、第三方集成等扩展奠定了基础。
