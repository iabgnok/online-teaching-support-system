{% from "macros.html" import dashboard_nav, unified_styles, page_header %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - åœ¨çº¿æ•™å­¦æ”¯æŒç³»ç»Ÿ</title>
    {{ unified_styles() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    var url = this.getAttribute('data-url');
                    if (url) {
                        window.location.href = url;
                    }
                });
            });
        });
    </script>
</head>
<body>
    <div class="container">
        {{ dashboard_nav('admin') }}
        
        {{ page_header('ğŸ” ç»¼åˆæŸ¥è¯¢', 'æŸ¥è¯¢ç”¨æˆ·ã€è¯¾ç¨‹ã€æ•™å­¦ç­ã€æˆç»©ç­‰å„ç±»ä¿¡æ¯') }}
        
        <div class="tabs">
            <div class="tab {% if query_type == 'user' %}active{% endif %}" data-url="{{ url_for('admin_query', type='user') }}">
                ç”¨æˆ·æŸ¥è¯¢
            </div>
            <div class="tab {% if query_type == 'course' %}active{% endif %}" data-url="{{ url_for('admin_query', type='course') }}">
                è¯¾ç¨‹æŸ¥è¯¢
            </div>
            <div class="tab {% if query_type == 'class' %}active{% endif %}" data-url="{{ url_for('admin_query', type='class') }}">
                æ•™å­¦ç­æŸ¥è¯¢
            </div>
            <div class="tab {% if query_type == 'department' %}active{% endif %}" data-url="{{ url_for('admin_query', type='department') }}">
                ç³»éƒ¨æŸ¥è¯¢
            </div>
            <div class="tab {% if query_type == 'grade' %}active{% endif %}" data-url="{{ url_for('admin_query', type='grade') }}">
                æˆç»©æŸ¥è¯¢
            </div>
        </div>
        
        <div class="content-section">
            <form method="POST" action="{{ url_for('admin_query') }}">
                <input type="hidden" name="query_type" value="{{ query_type }}">
                
                {% if query_type == 'user' %}
                <h3>ç”¨æˆ·æŸ¥è¯¢æ¡ä»¶</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" name="username" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>çœŸå®å§“å</label>
                        <input type="text" name="real_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>è§’è‰²</label>
                        <select name="role">
                            <option value="">å…¨éƒ¨</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                            <option value="teacher">æ•™å¸ˆ</option>
                            <option value="student">å­¦ç”Ÿ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>çŠ¶æ€</label>
                        <select name="status">
                            <option value="">å…¨éƒ¨</option>
                            <option value="1">æ¿€æ´»</option>
                            <option value="0">ç¦ç”¨</option>
                        </select>
                    </div>
                </div>
                
                {% elif query_type == 'course' %}
                <h3>è¯¾ç¨‹æŸ¥è¯¢æ¡ä»¶</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>è¯¾ç¨‹ä»£ç </label>
                        <input type="text" name="course_code" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>è¯¾ç¨‹åç§°</label>
                        <input type="text" name="course_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>è¯¾ç¨‹ç±»å‹</label>
                        <input type="text" name="course_type" placeholder="å¦‚ï¼šå¿…ä¿®ã€é€‰ä¿®">
                    </div>
                </div>
                
                {% elif query_type == 'class' %}
                <h3>æ•™å­¦ç­æŸ¥è¯¢æ¡ä»¶</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>è¯¾ç¨‹åç§°</label>
                        <input type="text" name="course_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>ç­çº§åç§°</label>
                        <input type="text" name="class_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>å­¦æœŸ</label>
                        <input type="text" name="semester" placeholder="å¦‚ï¼š2024-2025-1">
                    </div>
                </div>
                
                {% elif query_type == 'department' %}
                <h3>ç³»éƒ¨æŸ¥è¯¢æ¡ä»¶</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ç³»éƒ¨åç§°</label>
                        <input type="text" name="dept_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                </div>
                
                {% elif query_type == 'grade' %}
                <h3>æˆç»©æŸ¥è¯¢æ¡ä»¶</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>å­¦å·</label>
                        <input type="text" name="student_no" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>å­¦ç”Ÿå§“å</label>
                        <input type="text" name="student_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>è¯¾ç¨‹åç§°</label>
                        <input type="text" name="course_name" placeholder="æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢">
                    </div>
                    <div class="form-group">
                        <label>æœ€ä½æˆç»©</label>
                        <input type="number" name="min_grade" step="0.1" placeholder="å¦‚ï¼š60">
                    </div>
                    <div class="form-group">
                        <label>æœ€é«˜æˆç»©</label>
                        <input type="number" name="max_grade" step="0.1" placeholder="å¦‚ï¼š100">
                    </div>
                    <div class="form-group">
                        <label>æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯</label>
                        <select name="show_details">
                            <option value="0">ä»…æˆç»©</option>
                            <option value="1">åŒ…å«ä½œä¸šè€ƒè¯•è¯¦æƒ…</option>
                        </select>
                    </div>
                </div>
                {% endif %}
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">ğŸ” æŸ¥è¯¢</button>
                    <button type="reset" class="btn btn-secondary">ğŸ”„ é‡ç½®</button>
                </div>
            </form>
        </div>
        
        {% if results %}
        <div class="content-section">
            <div class="result-count" style="display: flex; justify-content: space-between; align-items: center;">
                <span>ğŸ“Š æŸ¥è¯¢ç»“æœï¼šå…± {{ results|length }} æ¡è®°å½•</span>
                <div>
                    {% if query_type == 'user' %}
                    <button onclick="toggleContactInfo()" class="btn btn-secondary" style="margin-right: 10px;" id="toggleContactBtn">
                        ğŸ‘ï¸ æ˜¾ç¤ºè”ç³»æ–¹å¼
                    </button>
                    {% endif %}
                    <a href="{{ url_for('admin_query_export', type=query_type, **request.args) }}" class="btn btn-success" style="text-decoration: none;">ğŸ“¥ å¯¼å‡ºCSV</a>
                </div>
            </div>
        
        <div style="overflow-x: auto;">
        
        {% if query_type == 'user' %}
        <table>
            <thead>
                <tr>
                    <th>ç”¨æˆ·ID</th>
                    <th>ç”¨æˆ·å</th>
                    <th>çœŸå®å§“å</th>
                    <th>è§’è‰²</th>
                    <th>å·¥å·/å­¦å·</th>
                    <th>å­¦é™¢/éƒ¨é—¨</th>
                    <th>èŒç§°</th>
                    <th>ä¸“ä¸š</th>
                    <th class="contact-column" style="display: none;">æ‰‹æœºå·</th>
                    <th class="contact-column" style="display: none;">é‚®ç®±</th>
                    <th>çŠ¶æ€</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                </tr>
            </thead>
            <tbody>
                {% for user in results %}
                <tr>
                    <td>{{ user.user_id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.real_name }}</td>
                    <td>
                        {% if user.role == 'admin' %}ç®¡ç†å‘˜
                        {% elif user.role == 'teacher' %}æ•™å¸ˆ
                        {% elif user.role == 'student' %}å­¦ç”Ÿ
                        {% else %}{{ user.role }}{% endif %}
                    </td>
                    <td>
                        {% if user.role == 'admin' and user.admin_profile %}
                            {{ user.admin_profile.admin_no }}
                        {% elif user.role == 'teacher' and user.teacher_profile %}
                            {{ user.teacher_profile.teacher_no }}
                        {% elif user.role == 'student' and user.student_profile %}
                            {{ user.student_profile.student_no }}
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        {% if user.role == 'admin' and user.admin_profile and user.admin_profile.department %}
                            {{ user.admin_profile.department.dept_name }}
                        {% elif user.role == 'teacher' and user.teacher_profile and user.teacher_profile.department %}
                            {{ user.teacher_profile.department.dept_name }}
                        {% elif user.role == 'student' and user.student_profile and user.student_profile.department %}
                            {{ user.student_profile.department.dept_name }}
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        {% if user.role == 'teacher' and user.teacher_profile %}
                            {{ user.teacher_profile.title or '-' }}
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        {% if user.role == 'student' and user.student_profile %}
                            {{ user.student_profile.major or '-' }}
                        {% else %}-{% endif %}
                    </td>
                    <td class="contact-column" style="display: none;">{{ user.phone or '-' }}</td>
                    <td class="contact-column" style="display: none;">{{ user.email or '-' }}</td>
                    <td class="{% if user.status == 1 %}status-active{% else %}status-inactive{% endif %}">
                        {{ 'æ¿€æ´»' if user.status == 1 else 'ç¦ç”¨' }}
                    </td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <script>
        let contactVisible = false;
        function toggleContactInfo() {
            contactVisible = !contactVisible;
            const contactColumns = document.querySelectorAll('.contact-column');
            const toggleBtn = document.getElementById('toggleContactBtn');
            
            contactColumns.forEach(col => {
                col.style.display = contactVisible ? 'table-cell' : 'none';
            });
            
            toggleBtn.textContent = contactVisible ? 'ğŸ™ˆ éšè—è”ç³»æ–¹å¼' : 'ğŸ‘ï¸ æ˜¾ç¤ºè”ç³»æ–¹å¼';
        }
        </script>
        
        {% elif query_type == 'course' %}
        <table>
            <thead>
                <tr>
                    <th>è¯¾ç¨‹ä»£ç </th>
                    <th>è¯¾ç¨‹åç§°</th>
                    <th>å­¦åˆ†</th>
                    <th>å­¦æ—¶</th>
                    <th>è¯¾ç¨‹ç±»å‹</th>
                    <th>æè¿°</th>
                </tr>
            </thead>
            <tbody>
                {% for course in results %}
                <tr>
                    <td>{{ course.course_code }}</td>
                    <td>{{ course.course_name }}</td>
                    <td>{{ course.credit }}</td>
                    <td>{{ course.hours or '-' }}</td>
                    <td>{{ course.course_type or '-' }}</td>
                    <td>{{ (course.description[:50] + '...') if course.description and course.description|length > 50 else (course.description or '-') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% elif query_type == 'class' %}
        <table>
            <thead>
                <tr>
                    <th>è¯¾ç¨‹åç§°</th>
                    <th>ç­çº§åç§°</th>
                    <th>å­¦æœŸ</th>
                    <th>ä¸Šè¯¾æ—¶é—´</th>
                    <th>æ•™å®¤</th>
                    <th>å®¹é‡</th>
                    <th>çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody>
                {% for teaching_class, course in results %}
                <tr>
                    <td>{{ course.course_name }}</td>
                    <td>{{ teaching_class.class_name }}</td>
                    <td>{{ teaching_class.semester }}</td>
                    <td>{{ teaching_class.class_time or '-' }}</td>
                    <td>{{ teaching_class.classroom or '-' }}</td>
                    <td>{{ teaching_class.capacity or '-' }}</td>
                    <td class="{% if teaching_class.status == 1 %}status-active{% else %}status-inactive{% endif %}">
                        {{ 'å¼€è¯¾ä¸­' if teaching_class.status == 1 else 'å·²ç»“æŸ' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% elif query_type == 'department' %}
        <table>
            <thead>
                <tr>
                    <th>ç³»éƒ¨ID</th>
                    <th>ç³»éƒ¨åç§°</th>
                    <th>æ•™å¸ˆäººæ•°</th>
                    <th>å­¦ç”Ÿäººæ•°</th>
                    <th>ç®¡ç†å‘˜äººæ•°</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                </tr>
            </thead>
            <tbody>
                {% for dept_info in results %}
                <tr>
                    <td>{{ dept_info.dept.dept_id }}</td>
                    <td>{{ dept_info.dept.dept_name }}</td>
                    <td>{{ dept_info.teacher_count }}</td>
                    <td>{{ dept_info.student_count }}</td>
                    <td>{{ dept_info.admin_count }}</td>
                    <td>{{ dept_info.dept.created_at.strftime('%Y-%m-%d') if dept_info.dept.created_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% elif query_type == 'grade' %}
        <table>
            <thead>
                <tr>
                    <th>å­¦å·</th>
                    <th>å§“å</th>
                    <th>è¯¾ç¨‹åç§°</th>
                    <th>ç­çº§</th>
                    <th>ä½œä¸šå¹³å‡</th>
                    <th>è€ƒè¯•å¹³å‡</th>
                    <th>æ•™å¸ˆè¯„ä»·</th>
                    <th>æœ€ç»ˆæˆç»©</th>
                    {% if show_details %}
                    <th>å·²äº¤ä½œä¸š</th>
                    <th>ç¼ºäº¤ä½œä¸š</th>
                    <th>å·²äº¤è€ƒè¯•</th>
                    <th>ç¼ºäº¤è€ƒè¯•</th>
                    <th>ä½œä¸šå®Œæˆç‡</th>
                    {% endif %}
                    <th>è®¡ç®—æ—¶é—´</th>
                </tr>
            </thead>
            <tbody>
                {% for item in results %}
                <tr>
                    <td>{{ item.student.student_no }}</td>
                    <td>{{ item.student.name }}</td>
                    <td>{{ item.course.course_name }}</td>
                    <td>{{ item.teaching_class.class_name }}</td>
                    <td>{{ '%.1f'|format(item.grade.homework_avg|float) }}</td>
                    <td>{{ '%.1f'|format(item.grade.exam_avg|float) }}</td>
                    <td>{{ '%.1f'|format(item.grade.teacher_evaluation|float) }}</td>
                    <td><strong>{{ '%.1f'|format(item.grade.final_grade|float) }}</strong></td>
                    {% if show_details %}
                    <td>{{ item.homework_submitted }}</td>
                    <td><span style="color: {% if item.homework_missing > 0 %}#e74c3c{% else %}#27ae60{% endif %}; font-weight: bold;">{{ item.homework_missing }}</span></td>
                    <td>{{ item.exam_submitted }}</td>
                    <td><span style="color: {% if item.exam_missing > 0 %}#e74c3c{% else %}#27ae60{% endif %}; font-weight: bold;">{{ item.exam_missing }}</span></td>
                    <td>
                        {% set completion_rate = ((item.homework_submitted / item.homework_total * 100)|round(1)) if item.homework_total > 0 else 0 %}
                        <span style="color: {% if completion_rate >= 80 %}#27ae60{% elif completion_rate >= 60 %}#f39c12{% else %}#e74c3c{% endif %}; font-weight: bold;">
                            {{ completion_rate }}%
                        </span>
                    </td>
                    {% endif %}
                    <td>{{ item.grade.calculated_at.strftime('%Y-%m-%d') if item.grade.calculated_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% endif %}
        </div>
        
        {% elif request.method == 'POST' %}
        <div class="content-section">
            <div class="empty-state">
                <p>ğŸ˜” æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•</p>
                <p style="font-size: 0.9em;">è¯·å°è¯•è°ƒæ•´æŸ¥è¯¢æ¡ä»¶</p>
            </div>
        </div>
        {% endif %}
    </div>
</body>
</html>