{% from "macros.html" import dashboard_nav, unified_styles, page_header %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - åœ¨çº¿æ•™å­¦æ”¯æŒç³»ç»Ÿ</title>
    {{ unified_styles() }}
    <style>
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        }
        .pending-highlight {
            background-color: #fff3cd !important;
        }
    </style>
</head>
<body>
    <div class="container">
        {{ dashboard_nav('teacher') }}
        
        {{ page_header(course.course_name + ' - ' + teaching_class.class_name, 'å­¦æœŸï¼š' + teaching_class.semester + ' | æ•™å®¤ï¼š' + (teaching_class.classroom or '-') + ' | æ—¶é—´ï¼š' + (teaching_class.class_time or '-')) }}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="content-section">
            <h2 class="section-title">ğŸ‘¥ å­¦ç”Ÿåå• ({{ students|length }} äºº)</h2>
            {% if students %}
            <table>
                <thead>
                    <tr>
                        <th>å­¦å·</th>
                        <th>å§“å</th>
                        <th>ä¸“ä¸š</th>
                        <th>é€‰è¯¾æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in students %}
                    <tr>
                        <td>{{ item.student.student_no }}</td>
                        <td>{{ item.student.name }}</td>
                        <td>{{ item.student.major or '-' }}</td>
                        <td>{{ item.enroll_time.strftime('%Y-%m-%d') if item.enroll_time else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>æš‚æ— å­¦ç”Ÿé€‰è¯¾</p>
            {% endif %}
        </div>

        <div class="content-section">
            <h2 class="section-title">ğŸ“ ä½œä¸šç®¡ç†</h2>
            <a href="{{ url_for('teacher_create_assignment', class_id=teaching_class.class_id, type='homework') }}" class="btn btn-success">+ å‘å¸ƒæ–°ä½œä¸š</a>
            
            {% set homeworks = assignments|selectattr('assignment.type', 'equalto', 'homework')|list %}
            {% if homeworks %}
            <table>
                <thead>
                    <tr>
                        <th>æ ‡é¢˜</th>
                        <th>æ€»åˆ†</th>
                        <th>æˆªæ­¢æ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>æäº¤ç»Ÿè®¡</th>
                        <th>å‘å¸ƒæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in homeworks %}
                    {% set assignment = item.assignment %}
                    {% set is_expired = assignment.deadline < assignment.deadline.__class__.now() %}
                    <tr{% if item.pending_count > 0 %} style="background-color: #fff3cd;"{% endif %}>
                        <td>{{ assignment.title }}</td>
                        <td>{{ assignment.total_score }}</td>
                        <td>{{ assignment.deadline.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if is_expired %}
                                <span style="color: #dc3545; font-weight: bold;">â° å·²æˆªæ­¢</span>
                            {% else %}
                                <span style="color: #28a745; font-weight: bold;">âœ… è¿›è¡Œä¸­</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.pending_count > 0 %}
                                <span style="color: #dc3545; font-weight: bold;">âš ï¸ {{ item.pending_count }} å¾…æ‰¹æ”¹</span><br>
                            {% endif %}
                            <span style="color: #666; font-size: 0.9em;">{{ item.graded_count }}/{{ item.total_submissions }} å·²æ‰¹</span>
                        </td>
                        <td>{{ assignment.publish_time.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <a href="{{ url_for('teacher_assignment_detail', assignment_id=assignment.assignment_id) }}" class="btn btn-primary">ğŸ“ è¿›å…¥æ‰¹æ”¹{% if item.pending_count > 0 %} ({{ item.pending_count }}){% endif %}</a>
                            <a href="{{ url_for('teacher_edit_assignment', assignment_id=assignment.assignment_id) }}" class="btn btn-secondary" style="background: #ffc107; color: #000;">âœï¸ ç¼–è¾‘</a>
                            {% if is_expired %}
                                <a href="{{ url_for('teacher_reopen_assignment', assignment_id=assignment.assignment_id) }}" class="btn" style="background: #17a2b8; color: white; padding: 8px 15px;">ğŸ”“ é‡æ–°å¼€æ”¾</a>
                            {% endif %}
                            <form method="POST" action="{{ url_for('teacher_delete_assignment', assignment_id=assignment.assignment_id) }}" style="display:inline;" 
                                  onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤ä½œä¸šã€Œ{{ assignment.title }}ã€å—ï¼Ÿæ‰€æœ‰ç›¸å…³æäº¤å’Œæˆç»©éƒ½å°†è¢«åˆ é™¤ï¼');">
                                <button type="submit" class="btn" style="background: #e74c3c; color: white; padding: 8px 15px; border: none; cursor: pointer; border-radius: 4px;">ğŸ—‘ï¸ åˆ é™¤</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>æš‚æ— ä½œä¸š</p>
            {% endif %}
        </div>

        <div class="content-section">
            <h2 class="section-title">ğŸ“‹ è€ƒè¯•ç®¡ç†</h2>
            <a href="{{ url_for('teacher_create_assignment', class_id=teaching_class.class_id, type='exam') }}" class="btn btn-success">+ å‘å¸ƒæ–°è€ƒè¯•</a>
            
            {% set exams = assignments|selectattr('assignment.type', 'equalto', 'exam')|list %}
            {% if exams %}
            <table>
                <thead>
                    <tr>
                        <th>æ ‡é¢˜</th>
                        <th>æ€»åˆ†</th>
                        <th>æ—¶é•¿(åˆ†é’Ÿ)</th>
                        <th>æˆªæ­¢æ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>æäº¤ç»Ÿè®¡</th>
                        <th>å‘å¸ƒæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in exams %}
                    {% set assignment = item.assignment %}
                    {% set is_expired = assignment.deadline < assignment.deadline.__class__.now() %}
                    <tr{% if item.pending_count > 0 %} style="background-color: #fff3cd;"{% endif %}>
                        <td>{{ assignment.title }}</td>
                        <td>{{ assignment.total_score }}</td>
                        <td>{{ assignment.duration or '-' }}</td>
                        <td>{{ assignment.deadline.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if is_expired %}
                                <span style="color: #dc3545; font-weight: bold;">â° å·²æˆªæ­¢</span>
                            {% else %}
                                <span style="color: #28a745; font-weight: bold;">âœ… è¿›è¡Œä¸­</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.pending_count > 0 %}
                                <span style="color: #dc3545; font-weight: bold;">âš ï¸ {{ item.pending_count }} å¾…æ‰¹æ”¹</span><br>
                            {% endif %}
                            <span style="color: #666; font-size: 0.9em;">{{ item.graded_count }}/{{ item.total_submissions }} å·²æ‰¹</span>
                        </td>
                        <td>{{ assignment.publish_time.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <a href="{{ url_for('teacher_assignment_detail', assignment_id=assignment.assignment_id) }}" class="btn btn-primary">ğŸ“ è¿›å…¥æ‰¹æ”¹{% if item.pending_count > 0 %} ({{ item.pending_count }}){% endif %}</a>
                            <a href="{{ url_for('teacher_edit_assignment', assignment_id=assignment.assignment_id) }}" class="btn btn-secondary" style="background: #ffc107; color: #000;">âœï¸ ç¼–è¾‘</a>
                            {% if is_expired %}
                                <a href="{{ url_for('teacher_reopen_assignment', assignment_id=assignment.assignment_id) }}" class="btn" style="background: #17a2b8; color: white; padding: 8px 15px;">ğŸ”“ é‡æ–°å¼€æ”¾</a>
                            {% endif %}
                            <form method="POST" action="{{ url_for('teacher_delete_assignment', assignment_id=assignment.assignment_id) }}" style="display:inline;" 
                                  onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è€ƒè¯•ã€Œ{{ assignment.title }}ã€å—ï¼Ÿæ‰€æœ‰ç›¸å…³æäº¤å’Œæˆç»©éƒ½å°†è¢«åˆ é™¤ï¼');">
                                <button type="submit" class="btn" style="background: #e74c3c; color: white; padding: 8px 15px; border: none; cursor: pointer; border-radius: 4px;">ğŸ—‘ï¸ åˆ é™¤</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>æš‚æ— è€ƒè¯•</p>
            {% endif %}
        </div>

        <div class="content-section">
            <h2 class="section-title">ğŸ“š æ•™å­¦èµ„æ–™ç®¡ç†</h2>
            <a href="{{ url_for('teacher_upload_material', class_id=teaching_class.class_id) }}" class="btn btn-success">+ ä¸Šä¼ æ•™å­¦èµ„æ–™</a>
            
            {% if materials %}
            <table>
                <thead>
                    <tr>
                        <th>æ ‡é¢˜</th>
                        <th>æ–‡ä»¶å</th>
                        <th>æ–‡ä»¶ç±»å‹</th>
                        <th>ä¸‹è½½æ¬¡æ•°</th>
                        <th>å‘å¸ƒæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for material in materials %}
                    <tr>
                        <td>{{ material.title }}</td>
                        <td>{{ material.file_name }}</td>
                        <td>{{ material.file_type.upper() }}</td>
                        <td>{{ material.download_count }}</td>
                        <td>{{ material.publish_time.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <a href="{{ url_for('download_material', material_id=material.material_id) }}" class="btn btn-primary">ä¸‹è½½</a>
                            <form method="POST" action="{{ url_for('teacher_delete_material', material_id=material.material_id) }}" style="display:inline;" 
                                  onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤æ•™å­¦èµ„æ–™ã€Œ{{ material.title }}ã€å—ï¼Ÿ');">
                                <button type="submit" class="btn" style="background: #e74c3c; color: white; padding: 8px 15px; border: none; cursor: pointer; border-radius: 4px;">ğŸ—‘ï¸ åˆ é™¤</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>æš‚æ— æ•™å­¦èµ„æ–™</p>
            {% endif %}
        </div>

        <div class="content-section">
            <h2 class="section-title">ğŸ“Š æˆç»©ç®¡ç†</h2>
            <a href="{{ url_for('teacher_class_grades', class_id=teaching_class.class_id) }}" class="btn btn-primary">æŸ¥çœ‹/ç®¡ç†æˆç»©</a>
            <a href="{{ url_for('teacher_class_grades_statistics', class_id=teaching_class.class_id) }}" class="btn btn-success" style="margin-left: 10px; background: #28a745;">ğŸ“ˆ æŸ¥çœ‹æˆç»©ç»Ÿè®¡</a>
        </div>
    </div>
</body>
</html>
